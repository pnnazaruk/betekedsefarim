<!DOCTYPE html><html lang="pl"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Library of Yeshivas Chachmei Lublin </title>
    <link rel="icon" href="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" type="image/png">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #fff; color: #1a1a1a; }
        body { display: flex; flex-direction: column; }

        #main-header {
            flex: 0 0 auto; background: #fff; color: #1a1a1a; padding: 15px 25px;
            display: flex; flex-direction: row-reverse; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #1a1a1a; z-index: 4000;
        }
        .header-title { font-family: "SBL Hebrew", serif; font-size: 24px; font-weight: bold; direction: rtl; text-align: right; }
        .header-links { display: flex; gap: 20px; font-size: 12px; text-transform: uppercase; font-weight: bold; }
        .header-links a { color: #1a1a1a; text-decoration: underline; }

        #app-container { display: flex; flex-direction: row; flex: 1; overflow: hidden; position: relative; }

        /* MOBILE TOGGLE */
        #mobile-toggle { display: none; background: #1a1a1a; color: #fff; border: none; padding: 12px; font-weight: bold; width: 100%; text-transform: uppercase; cursor: pointer; z-index: 3500; }
        
        #sidebar { 
            width: 280px; flex: 0 0 auto; background: #f9f9f9; border-right: 2px solid #1a1a1a; 
            padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; 
            transition: transform 0.3s ease;
        }

        /* FACETS */
        .facet-section { display: flex; flex-direction: column; gap: 10px; }
        .facet-title-wrapper { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #1a1a1a; padding-bottom: 5px; }
        .facet-title { font-size: 11px; font-weight: bold; text-transform: uppercase; }
        .facet-title.heb { font-family: "SBL Hebrew", serif; font-size: 14px; }
        .clear-btn { font-size: 9px; cursor: pointer; text-decoration: underline; color: #666; text-transform: uppercase; font-weight: bold; }

        .facet-list { list-style: none; padding: 0; margin: 0; max-height: 180px; overflow-y: auto; border: 1px solid #eee; background: #fff; }
        .facet-item { font-size: 12px; padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .facet-item:hover { background: #f5f5f5; }
        .facet-item.active { background: #1a1a1a !important; color: #fff !important; }
        .facet-item.disabled { color: #ccc; order: 100; opacity: 0.5; }
        .count-pill { font-size: 9px; background: #eee; padding: 2px 5px; border-radius: 10px; color: #333; }
        .active .count-pill { background: #444; color: #fff; }

        /* SLIDERS */
        .slider-wrapper { padding: 10px 0; }
        input[type=range] { width: 100%; accent-color: #1a1a1a; }
        .slider-val { font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; margin-top: 5px; }

        /* MAIN CONTENT */
        #main-content { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .controls { flex: 0 0 auto; background: #fff; padding: 15px 10px; border-bottom: 2px solid #1a1a1a; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        
        /* SEARCH BOX (THIN BORDER AS REQUESTED) */
        .search-wrapper { position: relative; width: 100%; }
        #search { width: 100%; padding: 10px 60px 10px 15px; border: 1px solid #1a1a1a; font-size: 17px; box-sizing: border-box; outline: none; background: #fdfdfd; }
        #inlineCounter { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: bold; color: #aaa; pointer-events: none; }

        /* HEBREW KEYBOARD */
        .kb-toggle { font-size: 11px; font-weight: bold; text-decoration: underline; cursor: pointer; text-transform: uppercase; color: #555; }
        .keyboard { display: none; grid-template-columns: repeat(9, 1fr); gap: 5px; padding: 10px; background: #f0f0f0; border: 1px solid #1a1a1a; margin-top: 5px; }
        .key { background: #fff; border: 1px solid #1a1a1a; padding: 10px 5px; text-align: center; cursor: pointer; font-family: "SBL Hebrew", serif; font-size: 18px; }
        .key:hover { background: #e0e0e0; }

        /* SORTING */
        .sort-wrapper { display: flex; gap: 10px; align-items: center; }
        select { padding: 8px; border: 1px solid #1a1a1a; background: #fff; cursor: pointer; font-size: 13px; flex: 1; }

        /* CARDS */
        #container { flex: 1 1 auto; overflow-y: scroll; padding: 15px 10px; box-sizing: border-box; background: #fff; }
        .item-card { border: 1px solid #eee; margin-bottom: 15px; padding: 18px; cursor: pointer; transition: all 0.2s ease; }
        .item-card:hover { border-color: #1a1a1a; background: #fcfcfc; }
        .row-flex { display: flex; justify-content: space-between; gap: 15px; }
        .title-pl { font-weight: bold; font-size: 17px; text-transform: uppercase; }
        .title-heb { font-size: 19px; direction: rtl; font-family: "SBL Hebrew", serif; }
        .author-row { border-top: 1px solid #eee; margin-top: 8px; padding-top: 10px; display: flex; justify-content: space-between; font-size: 14px; }
        .col-heb { text-align: right; font-family: "SBL Hebrew", serif; font-size: 16px; }

        /* MODAL */
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        #modalWindow { background: #fff; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; padding: 30px; position: relative; border: 2px solid #1a1a1a; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 30px; cursor: pointer; border: none; background: none; }
        .modal-body { display: flex; gap: 30px; flex-wrap: wrap; }
        .modal-img-col { flex: 0 0 200px; }
        .modal-img-col img { width: 100%; border: 1px solid #1a1a1a; }
        .modal-data-col { flex: 1; min-width: 300px; }
        .detail-box { border-bottom: 1px solid #eee; padding: 8px 0; }
        .label { font-size: 10px; font-weight: bold; color: #777; text-transform: uppercase; }
        
        .copy-link-area { margin-top: 20px; padding-top: 15px; border-top: 2px solid #1a1a1a; display: flex; flex-direction: column; gap: 5px; }
        .copy-btn { cursor: pointer; font-size: 12px; text-decoration: underline; background: none; border: none; padding: 0; text-align: left; font-weight: bold; color: #1a1a1a; }
        .link-btn { display: inline-block; background: #1a1a1a; color: #fff !important; padding: 10px 20px; font-size: 12px; text-decoration: none; text-transform: uppercase; font-weight: bold; margin-top: 10px; }

        @media (max-width: 768px) {
            #mobile-toggle { display: block; }
            #sidebar { position: absolute; left: 0; top: 0; height: 100%; transform: translateX(-100%); z-index: 3000; box-shadow: 10px 0 20px rgba(0,0,0,0.2); }
            #sidebar.open { transform: translateX(0); }
        }
    </style></head><body>

    <header id="main-header">
        <div class="header-title" dir="rtl">×‘×™×ª ×¢×§×“ ×¡×¤×¨im ×‘×™×©×™×‘×ª ×—×›××™ ×œ×•×‘×œ×™×Ÿ</div>
        <div class="header-links">
            <a href="https://teatrnn.pl/wystawy/biblioteka-jesziwy/" target="_blank">O projekcie</a>
            <a href="https://teatrnn.pl/wystawy/biblioteka-jesziwy/" target="_blank">About</a>
        </div>
    </header>

    <button id="mobile-toggle" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜° Filtry / Filters / ××¡× × ×™×</button>

    <div id="app-container">
        <aside id="sidebar">
            <div class="facet-section">
                <div class="facet-title-wrapper">
                    <span class="facet-title">Rok / Year</span>
                </div>
                <div class="slider-wrapper">
                    <input type="range" id="yearSlider" min="1500" max="1939" value="1939" oninput="updateYearLabel(this.value); filterAndSort();">
                    <div class="slider-val"><span>1500</span><span id="yearVal">1939</span></div>
                </div>
            </div>

            <div class="facet-section">
                <div class="facet-title-wrapper">
                    <span class="facet-title">Autor / Author</span>
                    <span class="clear-btn" onclick="clearFacet('author')">WyczyÅ›Ä‡ / Clear</span>
                </div>
                <ul id="authorListPL" class="facet-list"></ul>
            </div>

            <div class="facet-section">
                <div class="facet-title-wrapper">
                    <span class="facet-title">Miasto / City</span>
                    <span class="clear-btn" onclick="clearFacet('city')">WyczyÅ›Ä‡ / Clear</span>
                </div>
                <ul id="cityListPL" class="facet-list"></ul>
            </div>

            <div class="facet-section">
                <div class="facet-title-wrapper">
                    <span class="facet-title heb">× ×§×” ×”×›×œ</span>
                    <span class="clear-btn" onclick="clearFacet('all')">WyczyÅ›Ä‡ wszystko / Clear all</span>
                </div>
            </div>
        </aside>

        <main id="main-content">
            <div class="controls">
                <div class="search-wrapper">
                    <input type="text" id="search" placeholder="SZUKAJ / SEARCH / ×—×¤×©..." onkeyup="filterAndSort()">
                    <div id="inlineCounter"></div>
                </div>
                <span class="kb-toggle" onclick="toggleKeyboard()">Klawiatura hebrajska / ××§×œ×“×ª ×¢×‘×¨×™×ª</span>
                <div id="keyboard" class="keyboard">
                    <div class="key" onclick="addChar('×§')">×§</div><div class="key" onclick="addChar('×¨')">×¨</div><div class="key" onclick="addChar('×')">×</div>
                    <div class="key" onclick="addChar('×˜')">×˜</div><div class="key" onclick="addChar('×•')">×•</div><div class="key" onclick="addChar('×Ÿ')">×Ÿ</div>
                    <div class="key" onclick="addChar('×')">×</div><div class="key" onclick="addChar('×¤')">×¤</div><div class="key" onclick="delChar()">â†</div>
                    <div class="key" onclick="addChar('×©')">×©</div><div class="key" onclick="addChar('×“')">×“</div><div class="key" onclick="addChar('×’')">×’</div>
                    <div class="key" onclick="addChar('×›')">×›</div><div class="key" onclick="addChar('×¢')">×¢</div><div class="key" onclick="addChar('×™')">×™</div>
                    <div class="key" onclick="addChar('×—')">×—</div><div class="key" onclick="addChar('×œ')">×œ</div><div class="key" onclick="addChar('×š')">×š</div>
                    <div class="key" onclick="addChar('×–')">×–</div><div class="key" onclick="addChar('×¡')">×¡</div><div class="key" onclick="addChar('×‘')">×‘</div>
                    <div class="key" onclick="addChar('×”')">×”</div><div class="key" onclick="addChar('× ')">× </div><div class="key" onclick="addChar('×')">×</div>
                    <div class="key" onclick="addChar('×¦')">×¦</div><div class="key" onclick="addChar('×ª')">×ª</div><div class="key" onclick="addChar('×¥')">×¥</div>
                </div>
                <div class="sort-wrapper">
                    <select id="sortSelectPL" onchange="filterAndSort()">
                        <option value="none">Oryginalna kolejnoÅ›Ä‡ / Default</option>
                        <option value="title">TytuÅ‚ (A-Z) / Title</option>
                        <option value="year_asc">Rok â†‘ / Year Asc</option>
                        <option value="year_desc">Rok â†“ / Year Desc</option>
                    </select>
                </div>
            </div>
            <div id="loader" style="padding:20px;">Wczytywanie / Loading...</div>
            <div id="container"></div>
        </main>
    </div>

    <div id="modalOverlay" onclick="closeModal(event)">
        <div id="modalWindow">
            <button class="close-modal" onclick="closeModalManual()">&times;</button>
            <div id="modalContent" class="modal-body"></div>
        </div>
    </div>

    <script>
        let rawRows = [];
        let colLabels = [];
        let activeFilters = { city: new Set(), author: new Set() };
        let sheetId = '1N--MCZSwjbLchUT37i-Ph5TwHoMxqNXUsO_zPngtokg';
        let url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

        function extractYear(s) {
            if (!s || s === "---") return 0;
            let match = String(s).match(/\d{4}/);
            return match ? parseInt(match[0]) : 0;
        }

        async function init() {
            try {
                let r = await fetch(url);
                let t = await r.text();
                let json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
                rawRows = json.table.rows.map((row, idx) => ({ ...row, id: idx }));
                colLabels = json.table.cols;
                filterAndSort();
                document.getElementById('loader').style.display = 'none';
                
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('id')) openModal(urlParams.get('id'));
            } catch (e) { console.error(e); }
        }

        function getVal(cell) { return cell && (cell.f || (cell.v !== null ? String(cell.v) : "")) || ""; }
        function isUnknown(val) { let v = val ? val.trim() : ""; return !v || v === "---" || v === "-"; }
        function updateYearLabel(val) { document.getElementById('yearVal').innerText = val; }
        
        function toggleKeyboard() { let k = document.getElementById('keyboard'); k.style.display = k.style.display === 'grid' ? 'none' : 'grid'; }
        function addChar(c) { document.getElementById('search').value += c; filterAndSort(); }
        function delChar() { let s = document.getElementById('search'); s.value = s.value.slice(0,-1); filterAndSort(); }

        function clearFacet(type) {
            if (type === 'all') { activeFilters.city.clear(); activeFilters.author.clear(); }
            else activeFilters[type].clear();
            filterAndSort();
        }

        function toggleFilter(val, type) {
            if (activeFilters[type].has(val)) activeFilters[type].delete(val);
            else activeFilters[type].add(val);
            filterAndSort();
        }

        function filterAndSort() {
            const term = document.getElementById('search').value.toLowerCase().trim();
            const maxYear = parseInt(document.getElementById('yearSlider').value);
            const sortBy = document.getElementById('sortSelectPL').value;
            
            const filtered = rawRows.filter(r => {
                const city = getVal(r.c[7]), auth = getVal(r.c[3]), year = extractYear(getVal(r.c[5]));
                const matchSearch = r.c.some(c => getVal(c).toLowerCase().includes(term));
                const matchYear = year === 0 || year <= maxYear;
                const matchCity = activeFilters.city.size === 0 || (isUnknown(city) ? activeFilters.city.has('_UNK_') : activeFilters.city.has(city.trim()));
                const matchAuth = activeFilters.author.size === 0 || (isUnknown(auth) ? activeFilters.author.has('_UNK_') : activeFilters.author.has(auth.trim()));
                return matchSearch && matchYear && matchCity && matchAuth;
            });

            if(sortBy !== "none") {
                filtered.sort((a, b) => {
                    if (sortBy.includes("year")) {
                        let vA = extractYear(getVal(a.c[5])), vB = extractYear(getVal(b.c[5]));
                        return sortBy.includes("asc") ? vA - vB : vB - vA;
                    }
                    return getVal(a.c[1]).localeCompare(getVal(b.c[1]), 'pl');
                });
            }

            updateFacetUI(term, maxYear);
            render(filtered);
        }

        function updateFacetUI(term, maxYear) {
            const counts = { city: {}, author: {} };
            rawRows.forEach(r => {
                const city = isUnknown(getVal(r.c[7])) ? '_UNK_' : getVal(r.c[7]).trim();
                const auth = isUnknown(getVal(r.c[3])) ? '_UNK_' : getVal(r.c[3]).trim();
                const year = extractYear(getVal(r.c[5]));
                const searchMatch = r.c.some(c => getVal(c).toLowerCase().includes(term)) && (year === 0 || year <= maxYear);

                if (searchMatch && (activeFilters.author.size === 0 || activeFilters.author.has(auth))) counts.city[city] = (counts.city[city] || 0) + 1;
                if (searchMatch && (activeFilters.city.size === 0 || activeFilters.city.has(city))) counts.author[auth] = (counts.author[auth] || 0) + 1;
            });
            renderFacetList('authorListPL', counts.author, 'author');
            renderFacetList('cityListPL', counts.city, 'city');
        }

        function renderFacetList(id, counts, type) {
            const list = document.getElementById(id);
            const keys = Object.keys(counts).sort((a,b) => a.localeCompare(b));
            list.innerHTML = keys.map(val => {
                const active = activeFilters[type].has(val) ? 'active' : '';
                return `<li class="facet-item ${active}" onclick="toggleFilter('${val}', '${type}')">
                    <span>${val === '_UNK_' ? 'Nieznany' : val}</span><span class="count-pill">${counts[val] || 0}</span>
                </li>`;
            }).join('');
        }

        function render(rows) {
            const container = document.getElementById('container');
            container.innerHTML = rows.map(r => `
                <div class="item-card" onclick="openModal(${r.id})">
                    <div class="row-flex">
                        <span class="title-pl">${getVal(r.c[1])}</span>
                        <span class="title-heb">${getVal(r.c[2])}</span>
                    </div>
                    <div class="author-row">
                        <div class="col-pl"><span>${getVal(r.c[3])}</span><br><small>${getVal(r.c[7])}, ${getVal(r.c[5])}</small></div>
                        <div class="col-heb"><span>${getVal(r.c[4])}</span><br><small>${getVal(r.c[22]) || getVal(r.c[7])}, ${getVal(r.c[6])}</small></div>
                    </div>
                </div>
            `).join('');
            document.getElementById('inlineCounter').innerText = rows.length;
        }

        function openModal(id) {
            const r = rawRows.find(row => row.id == id);
            if(!r) return;
            let detailsHtml = "";
            for(let i=0; i<=22; i++) {
                if(!colLabels[i] || [8,19,20,21,22].includes(i)) continue;
                detailsHtml += `<div class="detail-box"><span class="label">${colLabels[i].label}</span><div class="value">${getVal(r.c[i]) || "---"}</div></div>`;
            }
            const currentLink = window.location.origin + window.location.pathname + "?id=" + id;
            document.getElementById('modalContent').innerHTML = `
                <div class="modal-img-col"><img src="${getVal(r.c[23])}"></div>
                <div class="modal-data-col">
                    ${detailsHtml}
                    <div class="copy-link-area">
                        <button class="copy-btn" onclick="copyToClipboard('${currentLink}')">ğŸ“„ Kopiuj link do tej pozycji / Copy link to this item</button>
                    </div>
                    <a href="${getVal(r.c[16])}" target="_blank" class="link-btn">ZOBACZ / SEE</a>
                </div>
            `;
            document.getElementById('modalOverlay').style.display = 'flex';
        }

        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => alert("Link skopiowany!")); }
        function closeModalManual() { document.getElementById('modalOverlay').style.display = 'none'; }
        function closeModal(e) { if(e.target.id === 'modalOverlay') closeModalManual(); }

        init();
    </script></body></html>
