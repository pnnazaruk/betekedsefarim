<!DOCTYPE html><html lang="pl"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Library of Yeshivas Chachmei Lublin </title>
    <link rel="icon" href="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey@0.12.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ORYGINALNY STYL WZORCOWY - NIEZMIENIONY ANI JEDEN ZNAK LOGIKI */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #fff; color: #1a1a1a; }
        body { display: flex; flex-direction: column; }
        #main-header { background: #fff; padding: 10px 20px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left img { height: 40px; }
        .header-left h1 { margin: 0; font-size: 18px; font-weight: 600; color: #333; }
        
        #search-container { background: #f8f9fa; padding: 15px 20px; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
        .search-wrapper { max-width: 800px; margin: 0 auto; position: relative; }
        #search-input { width: 100%; padding: 12px 45px 12px 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px; box-sizing: border-box; transition: all 0.2s; }
        #search-input:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
        
        #tabs { display: flex; background: #fff; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
        .tab-btn { padding: 12px 25px; border: none; background: none; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { background: #f0f0f0; }
        .tab-btn.active { color: #007bff; border-bottom-color: #007bff; }

        #content { flex-grow: 1; overflow: hidden; position: relative; }
        .tab-content { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: none; flex-direction: column; }
        .tab-content.active { display: flex; }

        /* LISTA */
        #list-view { overflow-y: auto; padding: 20px; }
        .book-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 20px; margin-bottom: 15px; transition: transform 0.2s, box-shadow 0.2s; display: grid; grid-template-columns: 1fr auto; gap: 20px; }
        .book-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-color: #d0d0d0; }
        .book-info h3 { margin: 0 0 10px 0; font-size: 17px; color: #007bff; line-height: 1.4; }
        .book-meta { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; font-size: 13px; color: #555; }
        .meta-item { display: flex; gap: 5px; }
        .meta-label { font-weight: 600; color: #888; min-width: 80px; }
        .book-actions { display: flex; align-items: center; }
        .btn-link { padding: 8px 16px; background: #007bff; color: #fff; text-decoration: none; border-radius: 6px; font-size: 13px; font-weight: 500; transition: background 0.2s; }
        .btn-link:hover { background: #0056b3; }

        /* STATYSTYKI */
        #stats-view { overflow-y: auto; padding: 20px; background: #f4f6f9; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 20px; max-width: 1400px; margin: 0 auto; }
        .chart-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); min-height: 350px; display: flex; flex-direction: column; }
        .chart-container h4 { margin: 0 0 15px 0; font-size: 15px; color: #333; text-align: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        canvas { flex-grow: 1; max-height: 400px; }
        #map { height: 500px; border-radius: 12px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); z-index: 1; }
        
        /* DODANO STYL DLA GRAFU */
        #network-graph { height: 600px; background: #fff; border-radius: 12px; margin-top: 20px; border: 1px solid #eee; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .book-card { grid-template-columns: 1fr; }
            .header-left h1 { font-size: 15px; }
            #map { height: 350px; }
        }
    </style>
</head>
<body>
    <header id="main-header">
        <div class="header-left">
            <img src="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" alt="Logo">
            <h1>Biblioteka Jeszywas Chachmej Lublin / Library of Yeshivas Chachmei Lublin</h1>
        </div>
    </header>
    <div id="search-container">
        <div class="search-wrapper">
            <input type="text" id="search-input" placeholder="Szukaj po tytule, autorze, miejscu lub drukarzu... / Search by title, author, place or printer...">
        </div>
    </div>
    <nav id="tabs">
        <button class="tab-btn active" onclick="switchTab('list')">Katalog / Catalog</button>
        <button class="tab-btn" onclick="switchTab('stats')">Statystyki i Mapy / Stats & Maps</button>
    </nav>
    <main id="content">
        <div id="list-view" class="tab-content active">
            <div id="results-count" style="margin-bottom:15px; font-size:13px; color:#666;"></div>
            <div id="book-list"></div>
        </div>
        <div id="stats-view" class="tab-content">
            <div class="stats-grid">
                <div class="chart-container"><canvas id="chartAuthors"></canvas></div>
                <div class="chart-container"><canvas id="chartPrinters"></canvas></div>
                <div class="chart-container" style="grid-column: 1 / -1;"><canvas id="chartYears"></canvas></div>
                <div class="chart-container" style="grid-column: 1 / -1;"><canvas id="chartPlaces"></canvas></div>
            </div>
            <div id="map"></div>
            <div id="network-graph"></div>
        </div>
    </main>
    <script>
        const SHEET_ID = '1X58S0-X0pY7W_4F_L5P-N09bE397-x8r5N7r_I0Yv40';
        const SHEET_TITLE = 'Arkusz1';
        const SHEET_RANGE = 'A2:K1000';
        const FULL_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${SHEET_TITLE}&range=${SHEET_RANGE}`;
        let rawRows = [];
        let fuse;
        let mapInstance;
        async function init() {
            try {
                const res = await fetch(FULL_URL);
                const text = await res.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                rawRows = json.table.rows;
                
                fuse = new Fuse(rawRows, {
                    keys: [
                        { name: 'c.1.v', weight: 1.0 },
                        { name: 'c.3.v', weight: 0.7 },
                        { name: 'c.7.v', weight: 0.5 },
                        { name: 'c.10.v', weight: 0.5 }
                    ],
                    threshold: 0.3,
                    distance: 100
                });

                renderList(rawRows);
                
                document.getElementById('search-input').addEventListener('input', (e) => {
                    const term = e.target.value;
                    if(!term) {
                        renderList(rawRows);
                    } else {
                        const results = fuse.search(term).map(r => r.item);
                        renderList(results);
                    }
                });

            } catch (err) {
                console.error("Error loading data:", err);
            }
        }

        function getVal(c) { return c && c.v ? c.v : '-'; }
        function isUnknown(val) { 
            if(!val || val === '-') return true;
            const v = val.toLowerCase();
            return v.includes('brak') || v.includes('nieznan') || v.includes('unknown');
        }

        function switchTab(mode) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            if(mode === 'list') {
                document.querySelector('[onclick="switchTab(\'list\')"]').classList.add('active');
                document.getElementById('list-view').classList.add('active');
            } else {
                document.querySelector('[onclick="switchTab(\'stats\')"]').classList.add('active');
                document.getElementById('stats-view').classList.add('active');
                setTimeout(() => {
                    if(!mapInstance) {
                        mapInstance = L.map('map').setView([50.0647, 19.9450], 5);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                    }
                    renderStats(rawRows);
                }, 100);
            }
        }

        function renderList(data) {
            const container = document.getElementById('book-list');
            const countEl = document.getElementById('results-count');
            container.innerHTML = '';
            countEl.innerText = `Znaleziono / Found: ${data.length}`;

            data.forEach(r => {
                const c = r.c;
                const card = document.createElement('div');
                card.className = 'book-card';
                card.innerHTML = `
                    <div class="book-info">
                        <h3>${getVal(c[1])}</h3>
                        <div class="book-meta">
                            <div class="meta-item"><span class="meta-label">Autor:</span> ${getVal(c[3])}</div>
                            <div class="meta-item"><span class="meta-label">Rok / Year:</span> ${getVal(c[5])}</div>
                            <div class="meta-item"><span class="meta-label">Miejsce:</span> ${getVal(c[7])}</div>
                            <div class="meta-item"><span class="meta-label">Drukarz:</span> ${getVal(c[10])}</div>
                        </div>
                    </div>
                    <div class="book-actions">
                        ${c[8] && c[8].v ? `<a href="${c[8].v}" target="_blank" class="btn-link">BC Polona</a>` : ''}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function parseDMS(str) {
            if(!str || str === '-') return null;
            const parts = str.split(',').map(s => parseFloat(s.trim()));
            return (parts.length === 2 && !isNaN(parts[0])) ? parts : null;
        }

        function renderStats(data) {
            const isMobile = window.innerWidth < 768;
            const colors = ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6610f2', '#fd7e14', '#20c997', '#e83e8c', '#6c757d', '#343a40'];
            
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return ` Liczba / Count: ${context.raw}`;
                            }
                        }
                    }
                }
            };

            const getTop = (arr, limit = 10) => {
                const counts = {};
                arr.forEach(v => {
                    if(!isUnknown(v)) counts[v] = (counts[v] || 0) + 1;
                });
                return Object.entries(counts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, limit);
            };

            const authors = getTop(data.map(r => getVal(r.c[3])));
            const printers = getTop(data.map(r => getVal(r.c[10])));
            const places = getTop(data.map(r => getVal(r.c[7])));
            
            const yearsRaw = {};
            data.forEach(r => {
                let y = parseInt(getVal(r.c[5]));
                if(y > 1400 && y < 1950) yearsRaw[y] = (yearsRaw[y] || 0) + 1;
            });
            const years = Object.entries(yearsRaw).sort((a,b) => a[0]-b[0]);

            const createChart = (id, type, labels, values, title) => {
                const ctx = document.getElementById(id).getContext('2d');
                if(window[id + 'Chart']) window[id + 'Chart'].destroy();
                window[id + 'Chart'] = new Chart(ctx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderRadius: 5
                        }]
                    },
                    options: {
                        ...commonOptions,
                        plugins: {
                            ...commonOptions.plugins,
                            title: { display: true, text: title, font: { size: 14, weight: 'bold' }, color: '#333', padding: 20 }
                        },
                        scales: type === 'bar' ? {
                            y: { beginAtZero: true, grid: { color: '#f0f0f0' } },
                            x: {
                                grid: { display: false },
                                ticks: { 
                                    font: { size: isMobile ? 9 : 11, weight: 'bold' }, 
                                    color: '#1a1a1a',
                                    callback: function(value) {
                                        let label = this.getLabelForValue(value);
                                        const maxLength = isMobile ? 18 : 35; 
                                        if (label.length > maxLength) {
                                            return label.substring(0, maxLength) + '...';
                                        }
                                        return label;
                                    }
                                }
                            }
                        } : {
                            y: { grid: { color: '#f0f0f0' } },
                            x: { grid: { color: '#f0f0f0' } }
                        }
                    }
                });
            };

            createChart('chartAuthors', 'bar', authors.map(e => e[0]), authors.map(e => e[1]), 'Top Autorzy / Top Authors');
            createChart('chartPrinters', 'bar', printers.map(e => e[0]), printers.map(e => e[1]), 'Top Drukarze / Top Printers');
            createChart('chartYears', 'line', years.map(e => e[0]), years.map(e => e[1]), 'Chronologia wydań / Chronology');

            const ctxP = document.getElementById('chartPlaces').getContext('2d');
            const pL = places.map(e => e[0]);
            const pD = places.map(e => e[1]);
            if(window.chartPlacesChart) window.chartPlacesChart.destroy();
            window.chartPlacesChart = new Chart(ctxP, {
                type: 'pie',
                data: {
                    labels: pL,
                    datasets: [{
                        data: pD,
                        backgroundColor: colors
                    }]
                },
                options: {
                    ...commonOptions,
                    plugins: {
                        ...commonOptions.plugins,
                        legend: { 
                            display: true, 
                            position: isMobile ? 'bottom' : 'right',
                            labels: { 
                                boxWidth: 12, 
                                font: { size: isMobile ? 10 : 12 },
                                padding: 10
                            }
                        },
                        title: { display: true, text: 'Miejsca wydania / Places of publication' }
                    }
                }
            });

            mapInstance.eachLayer(l => { if(l instanceof L.Marker) mapInstance.removeLayer(l); });
            const cities = {};
            data.forEach(r => {
                let name = getVal(r.c[7]), coords = parseDMS(getVal(r.c[9]));
                if(coords) {
                    let key = coords.join(',');
                    if(!cities[key]) cities[key] = { pos: coords, name: name, count: 0 };
                    cities[key].count++;
                }
            });
            Object.values(cities).forEach(c => {
                L.marker(c.pos).addTo(mapInstance).bindPopup(`<b>${c.name}</b><br>Książek / Books: ${c.count}`);
            });
            // WYWOŁANIE NOWEGO GRAFU
            renderNetworkGraph();
        }

        // --- NOWA FUNKCJA GRAFU (DODANA DO ORYGINALNEGO KODU) ---
        function renderNetworkGraph() {
            const data = rawRows;
            const isMobile = window.innerWidth < 768;

            const authCounts = {};
            data.forEach(r => {
                let a = getVal(r.c[3]);
                if (!isUnknown(a)) authCounts[a] = (authCounts[a] || 0) + 1;
            });

            const top10Authors = Object.entries(authCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10)
                .map(e => e[0]);

            const nodes = new vis.DataSet();
            const edges = new vis.DataSet();
            const addedNodes = new Set();

            nodes.add({
                id: 'center',
                label: 'Jeszywas Chachmej Lublin\nישיבת חכmi לובלין',
                color: { background: '#FFD700', border: '#FFD700', highlight: { background: '#FFD700', border: '#FFD700' } },
                size: 40, font: { size: 16, multi: true, weight: 'bold' }, shape: 'dot', borderWidth: 0
            });
            addedNodes.add('center');

            data.forEach(r => {
                const author = getVal(r.c[3]);
                if (top10Authors.includes(author)) {
                    const title = getVal(r.c[1]);
                    const city = getVal(r.c[7]);
                    const printer = getVal(r.c[10]);
                    const bookId = `book_${r.c[0] ? r.c[0].v : Math.random()}`;

                    if (!addedNodes.has(bookId)) {
                        nodes.add({ id: bookId, label: title, shape: 'dot', size: 12, color: '#000000', font: {size: 10} });
                        edges.add({ from: 'center', to: bookId, color: '#eeeeee', length: 200 });
                        addedNodes.add(bookId);
                    }

                    if (!isUnknown(author)) {
                        if (!addedNodes.has(author)) {
                            nodes.add({ id: author, label: author, shape: 'dot', size: 15, color: '#E91E63', title: `Autor: ${author}` });
                            addedNodes.add(author);
                        }
                        edges.add({ from: author, to: bookId, color: '#000000', width: 1 });
                    }

                    if (!isUnknown(city)) {
                        if (!addedNodes.has(city)) {
                            nodes.add({ id: city, label: city, shape: 'dot', size: 8, color: '#FF0000' });
                            addedNodes.add(city);
                        }
                        edges.add({ from: bookId, to: city, color: '#cccccc', dashes: true });
                    }

                    if (!isUnknown(printer)) {
                        if (!addedNodes.has(printer)) {
                            nodes.add({ id: printer, label: printer, shape: 'diamond', size: 15, color: '#40E0D0', title: `druk: ${printer}` });
                            addedNodes.add(printer);
                        }
                        edges.add({ from: printer, to: bookId, color: '#000000', dashes: true, width: 1 });
                    }
                }
            });

            const container = document.getElementById('network-graph');
            const options = {
                nodes: { borderWidth: 1, font: { color: '#34495e' } },
                physics: {
                    enabled: true,
                    barnesHut: { gravitationalConstant: -3000, centralGravity: 0.3, springLength: 120 },
                    stabilization: { iterations: 100 }
                },
                interaction: { hover: true, zoomView: !isMobile, dragView: true }
            };
            new vis.Network(container, { nodes, edges }, options);
        }

        // START INICJALIZACJI
        init();
    </script>
</body>
</html>
