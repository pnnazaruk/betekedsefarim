<!DOCTYPE html><html lang="pl"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Library of Yeshivas Chachmei Lublin </title>
    <link rel="icon" href="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ORYGINALNY STYL WZORCOWY - BEZ ZMIAN */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #fff; color: #1a1a1a; }
        body { display: flex; flex-direction: column; }
        #main-header { flex: 0 0 auto; background: #fff; color: #1a1a1a; padding: 15px 25px; display: flex; flex-direction: row-reverse; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a1a1a; z-index: 4000; }
        .header-title { font-family: "SBL Hebrew", serif; font-size: 24px; font-weight: bold; direction: rtl; text-align: right; }
        .header-links { display: flex; gap: 20px; font-size: 12px; text-transform: uppercase; font-weight: bold; }
        .header-links a { color: #1a1a1a; text-decoration: underline; }
        #app-container { display: flex; flex-direction: row; flex: 1; overflow: hidden; position: relative; }
        #mobile-toggle { display: none; background: #1a1a1a; color: #fff; border: none; padding: 12px; font-weight: bold; width: 100%; text-transform: uppercase; cursor: pointer; z-index: 3500; font-size: 13px; }
        #sidebar { width: 280px; flex: 0 0 auto; background: #f9f9f9; border-right: 2px solid #1a1a1a; padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; transition: transform 0.3s ease; }
        details.facet-container { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 5px; }
        summary.facet-summary { list-style: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: bold; text-transform: uppercase; outline: none; }
        summary.facet-summary::-webkit-details-marker { display: none; }
        summary.facet-summary::before { content: '▸'; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] summary.facet-summary::before { transform: rotate(90deg); }
        summary.heb { direction: rtl; font-family: "SBL Hebrew", serif; font-size: 14px; text-transform: none; }
        summary.heb::before { content: none; }
        summary.heb::after { content: '◂'; margin-left: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] summary.heb::after { transform: rotate(-90deg); }
        .active-badge { font-size: 9px; background: #1a1a1a; color: #fff; padding: 0 5px; border-radius: 3px; margin-left: 5px; }
        .facet-inner-content { padding-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .facet-mini-search { width: 100%; padding: 5px; font-size: 12px; border: 1px solid #ccc; box-sizing: border-box; outline: none; margin-bottom: 5px; }
        .facet-list { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; background: #fff; display: flex; flex-direction: column; }
        .facet-item { font-size: 12px; padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .facet-item:hover { background: #f5f5f5; }
        .facet-item.active { background: #1a1a1a !important; color: #fff !important; }
        .facet-item.heb { direction: rtl; text-align: right; font-family: "SBL Hebrew", serif; font-size: 14px; }
        .count-pill { font-size: 9px; background: #eee; padding: 2px 5px; border-radius: 10px; color: #333; }
        .active .count-pill { background: #444; color: #fff; }
        .slider-wrapper { padding: 10px 0; }
        .slider-wrapper.heb { direction: rtl; }
        input[type=range] { width: 100%; accent-color: #1a1a1a; }
        .slider-val { font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; margin-top: 5px; }
        #main-content { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .controls { flex: 0 0 auto; background: #fff; padding: 15px 10px; border-bottom: 2px solid #1a1a1a; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        #search { width: 100%; padding: 10px 60px 10px 15px; border: 1px solid #1a1a1a; font-size: 17px; box-sizing: border-box; outline: none; background: #fdfdfd; }
        #inlineCounter { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: bold; color: #aaa; pointer-events: none; }
        .kb-toggle { font-size: 11px; font-weight: bold; text-decoration: underline; cursor: pointer; text-transform: uppercase; color: #555; margin-bottom: 5px; }
        .keyboard { display: none; grid-template-columns: repeat(9, 1fr); gap: 5px; padding: 10px; background: #f0f0f0; border: 1px solid #1a1a1a; margin-top: 5px; }
        .key { background: #fff; border: 1px solid #1a1a1a; padding: 10px 5px; text-align: center; cursor: pointer; font-family: "SBL Hebrew", serif; font-size: 18px; transition: background 0.2s; }
        .key:hover { background: #e0e0e0; }
        .sort-wrapper { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; width: 100%; }
        .sort-container { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: bold; text-transform: uppercase; flex: 1; min-width: 180px; }
        .sort-container.heb { flex-direction: row-reverse; font-family: "SBL Hebrew", serif; font-size: 14px; }
        select { padding: 8px; border: 1px solid #1a1a1a; border-radius: 0; background: #fff; cursor: pointer; font-size: 13px; flex-grow: 1; }
        #container { flex: 1 1 auto; overflow-y: scroll; padding: 15px 10px; box-sizing: border-box; background: #fff; scroll-behavior: smooth; }
        .item-card { border: 1px solid #eee; margin-bottom: 15px; background: #fff; display: flex; flex-direction: column; width: 100%; box-sizing: border-box; transition: all 0.2s ease; cursor: pointer; }
        .item-card:hover { border-color: #1a1a1a; background: #fcfcfc; }
        .item-content { padding: 18px; }
        .row-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .title-pl { font-weight: bold; font-size: 17px; text-transform: uppercase; flex: 1; }
        .title-heb { font-size: 19px; color: #1a1a1a; text-align: right; direction: rtl; flex: 1; font-family: "SBL Hebrew", serif; }
        .author-row { border-top: 1px solid #eee; padding-top: 10px; margin-top: 8px; display: flex; justify-content: space-between; gap: 20px; }
        .column-pl { font-size: 15px; color: #333; flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .column-he { font-size: 16px; color: #222; text-align: right; direction: rtl; flex: 1; display: flex; flex-direction: column; gap: 4px; font-family: "SBL Hebrew", serif; }
        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        #modalWindow { background: #fff; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; padding: 30px; position: relative; border: 2px solid #1a1a1a; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 30px; cursor: pointer; border: none; background: none; }
        .modal-body { display: flex; gap: 30px; flex-wrap: wrap; }
        .modal-img-col { flex: 0 0 200px; text-align: center; }
        .modal-img-col img { width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #1a1a1a; margin-bottom: 15px; }
        .modal-data-col { flex: 1; min-width: 300px; }
        .detail-box { border-bottom: 1px solid #eee; padding: 10px 0; }
        .label { font-size: 10px; font-weight: bold; color: #777; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .link-btn { display: inline-block; background: #1a1a1a; color: #fff !important; padding: 10px 20px; font-size: 12px; text-decoration: none; text-transform: uppercase; font-weight: bold; margin-top: 10px; transition: background 0.3s; border: none; cursor: pointer; }
        .link-btn:hover { background: #555; }
        .clear-btn { font-size: 9px; cursor: pointer; text-decoration: underline; color: #666; font-weight: bold; text-transform: uppercase; }

        /* NOWE STYLE DASHBOARDU - ODIZOLOWANE */
        .nav-btn { background: none; border: 1px solid #1a1a1a; padding: 0 15px; cursor: pointer; font-size: 11px; font-weight: bold; text-transform: uppercase; height: 35px; box-sizing: border-box; display: inline-flex; align-items: center; margin-left: 10px; color: #1a1a1a; }
        .nav-btn.active { background: #1a1a1a; color: #fff; }
        #dashboard-view { display: none; flex: 1; overflow-y: auto; padding: 20px; background: #f9f9f9; flex-direction: column; gap: 20px; position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 2000; }
        body.stats-active #dashboard-view { display: flex; }
        body.stats-active #sidebar, body.stats-active .controls, body.stats-active #container { visibility: hidden; pointer-events: none; }
        .chart-container { background: #fff; border: 1px solid #1a1a1a; padding: 15px; }
        .bottom-row { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        #map { height: 400px; width: 100%; border: 1px solid #1a1a1a; }
        .stat-title { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    </style></head><body>

    <header id="main-header">
        <div class="header-title" dir="rtl">בית עקד ספרים בישיבת חכמי לובלין</div>
        <div class="header-links">
            <button class="nav-btn active" id="btn-catalog" onclick="switchView('catalog')">Katalog</button>
            <button class="nav-btn" id="btn-stats" onclick="switchView('stats')">Statystyki</button>
            <a href="https://teatrnn.pl/wystawy/biblioteka-jesziwy/" target="_blank">O projekcie / About</a>
        </div>
    </header>

    <button id="mobile-toggle" onclick="toggleSidebar()">☰ Filtry / Filters / מסננים</button>

    <div id="app-container">
        <aside id="sidebar">
            <div class="facet-section">
                <div class="facet-header"><span class="facet-title">Rok / Year</span></div>
                <div class="slider-wrapper">
                    <input type="range" id="yearSlider" min="1500" max="1939" value="1939" oninput="updateYearLabel(this.value); filterAndSort();">
                    <div class="slider-val"><span>1500</span><span id="yearVal">1939</span></div>
                </div>
            </div>
            <div class="facet-section" style="direction: rtl;">
                <div class="facet-header" style="display: flex; flex-direction: row; justify-content: flex-start;"><span class="facet-title heb">שנה</span></div>
                <div class="slider-wrapper heb">
                    <input type="range" id="hebYearSlider" min="5260" max="5700" value="5700" oninput="updateHebYearLabel(this.value); filterAndSort();">
                    <div class="slider-val" style="direction: rtl;"><span>ש"ק</span><span id="hebYearVal">ת"ש</span></div>
                </div>
            </div>
            <div class="facet-section" style="border-top: 1px solid #1a1a1a; padding-top: 10px;">
                <span class="clear-btn" style="text-align: center; display: block;" onclick="clearFacet('all')">Wyczyść wszystko / Reset all / נקה הכל</span>
            </div>
            <details class="facet-container" id="det-author"><summary class="facet-summary">Autor / Author <span class="active-badge" style="display:none">0</span></summary><div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'authorListPL')"><ul id="authorListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-city"><summary class="facet-summary">Miasto / City <span class="active-badge" style="display:none">0</span></summary><div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'cityListPL')"><ul id="cityListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-printer"><summary class="facet-summary">Druk / Printer <span class="active-badge" style="display:none">0</span></summary><div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'printerListPL')"><ul id="printerListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-loc"><summary class="facet-summary">Lokalizacja / Location <span class="active-badge" style="display:none">0</span></summary><div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'locListPL')"><ul id="locListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-author-he"><summary class="facet-summary heb">מחבר <span class="active-badge" style="display:none">0</span></summary><div class="facet-inner-content"><input type="text" class="facet-mini-search" dir="rtl" placeholder="סנן..." onkeyup="filterFacetList(this, 'authorListHE')"><ul id="authorListHE" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-city-he"><summary class="facet-summary heb">עיר <span class="active-badge" style="display:none">0</span></summary><div class="facet-inner-content"><input type="text" class="facet-mini-search" dir="rtl" placeholder="סנן..." onkeyup="filterFacetList(this, 'cityListHE')"><ul id="cityListHE" class="facet-list"></ul></div></details>
        </aside>

        <main id="main-content">
            <div class="controls" id="search-controls">
                <div class="search-wrapper">
                    <input type="text" id="search" placeholder="SZUKAJ / SEARCH / חפש..." onkeyup="filterAndSort()">
                    <div id="inlineCounter"></div>
                </div>
                <span class="kb-toggle" onclick="toggleKeyboard()">KLAWIATURA HEBRAJSKA / מקלדת עברית</span>
                <div id="keyboard" class="keyboard">
                    <div class="key" onclick="addChar('ק')">ק</div><div class="key" onclick="addChar('ר')">ר</div><div class="key" onclick="addChar('א')">א</div>
                    <div class="key" onclick="addChar('ט')">ט</div><div class="key" onclick="addChar('ו')">ו</div><div class="key" onclick="addChar('ן')">ן</div>
                    <div class="key" onclick="addChar('ם')">ם</div><div class="key" onclick="addChar('פ')">פ</div><div class="key" onclick="delChar()">←</div>
                    <div class="key" onclick="addChar('ש')">ש</div><div class="key" onclick="addChar('ד')">ד</div><div class="key" onclick="addChar('ג')">ג</div>
                    <div class="key" onclick="addChar('כ')">כ</div><div class="key" onclick="addChar('ע')">ע</div><div class="key" onclick="addChar('י')">י</div>
                    <div class="key" onclick="addChar('ח')">ח</div><div class="key" onclick="addChar('ל')">ל</div><div class="key" onclick="addChar('ך')">ך</div>
                    <div class="key" onclick="addChar('ז')">ז</div><div class="key" onclick="addChar('ס')">ס</div><div class="key" onclick="addChar('ב')">ב</div>
                    <div class="key" onclick="addChar('ה')">ה</div><div class="key" onclick="addChar('נ')">נ</div><div class="key" onclick="addChar('מ')">מ</div>
                    <div class="key" onclick="addChar('צ')">צ</div><div class="key" onclick="addChar('ת')">ת</div><div class="key" onclick="addChar('ץ')">ץ</div>
                </div>
                <div class="sort-wrapper">
                    <div class="sort-container"><span>Sortuj wg / Sort by:</span>
                        <select id="sortSelectPL" onchange="updateSort('PL')">
                            <option value="none">Oryginalna kolejność</option>
                            <option value="title">Tytuł (A-Z)</option>
                            <option value="author">Autor (A-Z)</option>
                            <option value="year_asc">Rok (Rosnąco)</option>
                            <option value="year_desc">Rok (Malejąco)</option>
                        </select>
                    </div>
                    <div class="sort-container heb"><span>:מיין לפי</span>
                        <select id="sortSelectHE" onchange="updateSort('HE')">
                            <option value="none">סדר מקורי</option>
                            <option value="title_he">כותרת</option>
                            <option value="author_he">מחבר</option>
                            <option value="year_asc_he">שנה (מהישן لחדש)</option>
                            <option value="year_desc_he">שנה (מהחדש לישן)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="loader" style="padding:20px;">Wczytywanie / Loading...</div>
            <div id="container"></div>

            <div id="dashboard-view">
                <div class="chart-container">
                    <div class="stat-title">Lata wydania / Number of books per year</div>
                    <div style="height: 250px;"><canvas id="timelineChart"></canvas></div>
                </div>
                <div class="bottom-row">
                    <div class="chart-container"><div class="stat-title">Miejsca druku / Printing map</div><div id="map"></div></div>
                    <div class="chart-container"><div class="stat-title">Lokalizacja / Current location</div><div style="height: 350px;"><canvas id="locChart"></canvas></div></div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalOverlay" onclick="closeModal(event)"><div id="modalWindow"><button class="close-modal" onclick="closeModalManual()">&times;</button><div id="modalContent" class="modal-body"></div></div></div>

    <script>
        /* ORYGINALNY KOD WZORCOWY - NIEZMIENIONY */
        let rawRows = [];
        let colLabels = [];
        let activeFilters = { city: new Set(), author: new Set(), printer: new Set(), loc: new Set() };
        let sheetId = '1N--MCZSwjbLchUT37i-Ph5TwHoMxqNXUsO_zPngtokg';
        let url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
        let fuse;
        let isInitialLoad = true;

        function extractYear(s) { if (!s || s === "---") return 0; let match = String(s).match(/\d{4}/); return match ? parseInt(match[0]) : 0; }
        function hebrewYearToNumber(s) { 
            if (!s || s === "---") return 999999; 
            let c = String(s).replace(/[\\\"\'\.\s\(\)\[\]]/g, "").trim(); 
            let v = {'א':1,'ב':2,'ג':3,'ד':4,'ה':5,'ו':6,'ז':7,'ח':8,'ט':9,'י':10,'כ':20,'ך':20,'ל':30,'מ':40,'ם':40,'נ':50,'ן':50,'ס':60,'ע':70,'פ':80,'ף':80,'צ':90,'ץ':90,'ק':100,'ר':200,'ש':300,'ת':400}; 
            let sum = 0; let cleanC = c.match(/[\u0590-\u05FF]/g);
            if (cleanC) { for (let i=0; i < cleanC.length; i++) sum += v[cleanC[i]] || 0; }
            if (sum > 0 && sum < 1000) sum += 5000; return sum || 999999; 
        }
        function numberToHebrewYear(num) {
            let n = parseInt(num); if (n > 5000) n -= 5000;
            let heb = "", vArr = [400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1], lArr = ['ת','ש','ר','ק','צ','פ','ע','ס','נ','מ','ל','כ','י','ט','ח','ז','ו','ה','ד','ג','ב','א'];
            for(let i=0; i<vArr.length; i++) { while(n >= vArr[i]) { heb += lArr[i]; n -= vArr[i]; } }
            return heb;
        }

        async function init() {
            try {
                let r = await fetch(url);
                let t = await r.text();
                let json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
                rawRows = json.table.rows;
                colLabels = json.table.cols;
                const fuseData = rawRows.map(row => ({ original: row, searchable: row.c.map(cell => getVal(cell)).join(' ') }));
                fuse = new Fuse(fuseData, { keys: ['searchable'], threshold: 0.3, ignoreLocation: true });
                applyURLState();
                filterAndSort();
                document.getElementById('loader').style.display = 'none';
                window.addEventListener('popstate', () => { applyURLState(); filterAndSort(false); });
            } catch (e) { console.error(e); }
        }

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function getVal(cell) { return cell && (cell.f || (cell.v !== null ? String(cell.v) : "")) || ""; }
        function isUnknown(val) { let v = val ? val.trim() : ""; return !v || v === "---" || v === "-"; }
        function updateYearLabel(val) { document.getElementById('yearVal').innerText = val; }
        function updateHebYearLabel(val) { document.getElementById('hebYearVal').innerText = numberToHebrewYear(val); }
        function toggleKeyboard() { let k = document.getElementById('keyboard'); k.style.display = k.style.display === 'grid' ? 'none' : 'grid'; }
        function addChar(c) { document.getElementById('search').value += c; filterAndSort(); }
        function delChar() { let s = document.getElementById('search'); s.value = s.value.slice(0,-1); filterAndSort(); }

        function filterFacetList(input, listId) {
            let filter = input.value.toLowerCase();
            let items = document.querySelectorAll(`#${listId} li`);
            items.forEach(li => {
                let span = li.querySelector('span');
                if (span) {
                    let txt = span.innerText.toLowerCase();
                    li.style.display = txt.includes(filter) ? "flex" : "none";
                }
            });
        }

        function clearFacet(type) {
            if (type === 'all') { 
                activeFilters.city.clear(); activeFilters.author.clear(); activeFilters.printer.clear(); activeFilters.loc.clear(); 
                document.getElementById('yearSlider').value = 1939;
                document.getElementById('hebYearSlider').value = 5700;
                updateYearLabel(1939); updateHebYearLabel(5700);
                document.getElementById('search').value = "";
            } else activeFilters[type].clear();
            filterAndSort();
        }

        function toggleFilter(val, type) {
            if (activeFilters[type].has(val)) activeFilters[type].delete(val);
            else activeFilters[type].add(val);
            filterAndSort();
        }

        function filterAndSort(updateURL = true) {
            const term = document.getElementById('search').value.toLowerCase().trim();
            const maxYear = parseInt(document.getElementById('yearSlider').value);
            const maxHebYear = parseInt(document.getElementById('hebYearSlider').value);
            const sPL = document.getElementById('sortSelectPL').value;
            const sHE = document.getElementById('sortSelectHE').value;

            let searchFiltered = (term && fuse) ? fuse.search(term).map(r => r.item.original) : rawRows;

            const filtered = searchFiltered.filter(r => {
                const cityPL = getVal(r.c[7]), authPL = getVal(r.c[3]), prnPL = getVal(r.c[10]), locPL = getVal(r.c[11]);
                const year = extractYear(getVal(r.c[5])), hebYear = hebrewYearToNumber(getVal(r.c[6]));
                const matchYear = (year === 0 || year <= maxYear) && (hebYear === 999999 || hebYear <= maxHebYear);
                const matchCity = activeFilters.city.size === 0 || (isUnknown(cityPL) ? activeFilters.city.has('_UNK_') : activeFilters.city.has(cityPL.trim()));
                const matchAuth = activeFilters.author.size === 0 || (isUnknown(authPL) ? activeFilters.author.has('_UNK_') : activeFilters.author.has(authPL.trim()));
                const matchPrn = activeFilters.printer.size === 0 || (isUnknown(prnPL) ? activeFilters.printer.has('_UNK_') : activeFilters.printer.has(prnPL.trim()));
                const matchLoc = activeFilters.loc.size === 0 || (isUnknown(locPL) ? activeFilters.loc.has('_UNK_') : activeFilters.loc.has(locPL.trim()));
                return matchYear && matchCity && matchAuth && matchPrn && matchLoc;
            });

            const sortVal = sPL !== "none" ? sPL : sHE;
            if(sortVal !== "none") {
                filtered.sort((a, b) => {
                    const norm = (s) => getVal(s).replace(/[\[\]]/g, "").toLowerCase().trim();
                    if (sortVal.includes("year")) {
                        let vA = extractYear(getVal(a.c[5])), vB = extractYear(getVal(b.c[5]));
                        if (sortVal.includes("_he")) { vA = hebrewYearToNumber(getVal(a.c[6])); vB = hebrewYearToNumber(getVal(b.c[6])); }
                        if (vA === 0 || vA === 999999) return 1; if (vB === 0 || vB === 999999) return -1;
                        return sortVal.includes("desc") ? vB - vA : vA - vB;
                    }
                    let i = 1;
                    if (sortVal === 'title_he') i = 2;
                    else if (sortVal === 'author') i = 3;
                    else if (sortVal === 'author_he') i = 4;
                    let valA = norm(a.c[i]), valB = norm(b.c[i]);
                    const isAUnknown = isUnknown(valA), isBUnknown = isUnknown(valB);
                    if (isAUnknown && !isBUnknown) return 1;
                    if (!isAUnknown && isBUnknown) return -1;
                    return valA.localeCompare(valB, sortVal.includes('_he') ? 'he' : 'pl');
                });
            }

            updateFacetsUI(term, maxYear, maxHebYear);
            render(filtered);
            if (updateURL) syncStateToURL();
            if (isInitialLoad) {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('id')) openModal(urlParams.get('id'));
                isInitialLoad = false;
            }
            return filtered; /* DODANE: Dashboard potrzebuje tych danych */
        }

        function updateFacetsUI(term, maxYear, maxHebYear) {
            const counts = { city: {}, author: {}, printer: {}, loc: {} };
            const plToHe = { city: {}, author: {} };
            let searchFiltered = (term && fuse) ? fuse.search(term).map(r => r.item.original) : rawRows;

            searchFiltered.forEach(r => {
                const cityPL = getVal(r.c[7]), authPL = getVal(r.c[3]), prnPL = getVal(r.c[10]), locPL = getVal(r.c[11]);
                const cityHE = getVal(r.c[22]) || cityPL, authHE = getVal(r.c[4]) || authPL;
                const year = extractYear(getVal(r.c[5])), hebYear = hebrewYearToNumber(getVal(r.c[6]));
                if (!((year === 0 || year <= maxYear) && (hebYear === 999999 || hebYear <= maxHebYear))) return;
                const passCity = (activeFilters.author.size === 0 || (isUnknown(authPL) ? activeFilters.author.has('_UNK_') : activeFilters.author.has(authPL.trim()))) && (activeFilters.printer.size === 0 || (isUnknown(prnPL) ? activeFilters.printer.has('_UNK_') : activeFilters.printer.has(prnPL.trim()))) && (activeFilters.loc.size === 0 || (isUnknown(locPL) ? activeFilters.loc.has('_UNK_') : activeFilters.loc.has(locPL.trim())));
                const passAuth = (activeFilters.city.size === 0 || (isUnknown(cityPL) ? activeFilters.city.has('_UNK_') : activeFilters.city.has(cityPL.trim()))) && (activeFilters.printer.size === 0 || (isUnknown(prnPL) ? activeFilters.printer.has('_UNK_') : activeFilters.printer.has(prnPL.trim()))) && (activeFilters.loc.size === 0 || (isUnknown(locPL) ? activeFilters.loc.has('_UNK_') : activeFilters.loc.has(locPL.trim())));
                const passPrn = (activeFilters.city.size === 0 || (isUnknown(cityPL) ? activeFilters.city.has('_UNK_') : activeFilters.city.has(cityPL.trim()))) && (activeFilters.author.size === 0 || (isUnknown(authPL) ? activeFilters.author.has('_UNK_') : activeFilters.author.has(authPL.trim()))) && (activeFilters.loc.size === 0 || (isUnknown(locPL) ? activeFilters.loc.has('_UNK_') : activeFilters.loc.has(locPL.trim())));
                const passLoc = (activeFilters.city.size === 0 || (isUnknown(cityPL) ? activeFilters.city.has('_UNK_') : activeFilters.city.has(cityPL.trim()))) && (activeFilters.author.size === 0 || (isUnknown(authPL) ? activeFilters.author.has('_UNK_') : activeFilters.author.has(authPL.trim()))) && (activeFilters.printer.size === 0 || (isUnknown(prnPL) ? activeFilters.printer.has('_UNK_') : activeFilters.printer.has(prnPL.trim())));
                if (passCity) { let k = isUnknown(cityPL)?'_UNK_':cityPL.trim(); counts.city[k] = (counts.city[k]||0)+1; plToHe.city[k] = isUnknown(cityPL)?'לא ידוע':cityHE.trim(); }
                if (passAuth) { let k = isUnknown(authPL)?'_UNK_':authPL.trim(); counts.author[k] = (counts.author[k]||0)+1; plToHe.author[k] = isUnknown(authPL)?'לא ידוע':authHE.trim(); }
                if (passPrn) { let k = isUnknown(prnPL)?'_UNK_':prnPL.trim(); counts.printer[k] = (counts.printer[k]||0)+1; }
                if (passLoc) { let k = isUnknown(locPL)?'_UNK_':locPL.trim(); counts.loc[k] = (counts.loc[k]||0)+1; }
            });
            renderFacetList('authorListPL', counts.author, 'author', false, 'Wszystko/ All', 'Nieznany/ Unknown', null);
            renderFacetList('cityListPL', counts.city, 'city', false, 'Wszystko/ All', 'Nieznane/ Unknown', null);
            renderFacetList('printerListPL', counts.printer, 'printer', false, 'Wszystko/ All', 'Nieznany/ Unknown', null);
            renderFacetList('locListPL', counts.loc, 'loc', false, 'Wszystko/ All', 'Nieznana/ Unknown', null);
            renderFacetList('authorListHE', counts.author, 'author', true, 'הכל', 'לא ידוע', plToHe.author);
            renderFacetList('cityListHE', counts.city, 'city', true, 'הכל', 'לא ידוע', plToHe.city);
            updateBadges();
        }

        function updateBadges() {
            Object.keys(activeFilters).forEach(type => {
                let count = activeFilters[type].size;
                let badge = document.querySelector(`#det-${type} .active-badge`);
                let badgeHE = document.querySelector(`#det-${type}-he .active-badge`);
                if(badge) { badge.innerText = count; badge.style.display = count > 0 ? 'inline' : 'none'; }
                if(badgeHE) { badgeHE.innerText = count; badgeHE.style.display = count > 0 ? 'inline' : 'none'; }
            });
        }

        function renderFacetList(id, counts, type, isHeb, allLabel, unknownLabel, heMap) {
            const list = document.getElementById(id); const activeSet = activeFilters[type];
            let html = `<li class="facet-item ${isHeb?'heb':''} ${activeSet.size===0?'active':''}" onclick="clearFacet('${type}')">${allLabel}</li>`;
            const sortedKeys = Object.keys(counts).filter(k => k !== '_UNK_').sort((a,b) => {
                let valA = isHeb ? heMap[a] : a; let valB = isHeb ? heMap[b] : b;
                let aBr = valA.startsWith('['), bBr = valB.startsWith('[');
                if (aBr && !bBr) return 1; if (!aBr && bBr) return -1;
                return valA.localeCompare(valB, isHeb ? 'he' : 'pl');
            });
            sortedKeys.forEach(k => {
                const label = isHeb ? heMap[k] : k;
                html += `<li class="facet-item ${isHeb?'heb':''} ${activeSet.has(k)?'active':''}" onclick="toggleFilter('${k}', '${type}')"><span>${label}</span><span class="count-pill">${counts[k]}</span></li>`;
            });
            if (counts['_UNK_']) html += `<li class="facet-item ${isHeb?'heb':''} ${activeSet.has('_UNK_')?'active':''}" onclick="toggleFilter('_UNK_', '${type}')"><span>${unknownLabel}</span><span class="count-pill">${counts['_UNK_']}</span></li>`;
            list.innerHTML = html;
        }

        function render(rows) {
            const container = document.getElementById('container');
            container.innerHTML = rows.map(r => `
                <div class="item-card" onclick="openModal('${r.c[0].v}')">
                    <div class="item-content"><div class="row-flex"><span class="title-pl">${getVal(r.c[1])}</span><span class="title-heb">${getVal(r.c[2])}</span></div>
                        <div class="author-row"><div class="column-pl"><span>${getVal(r.c[3])}</span><span style="font-size:12px;color:#888">${getVal(r.c[7])}, ${getVal(r.c[5])}</span></div>
                            <div class="column-he"><span>${getVal(r.c[4])}</span><span style="font-size:13px;color:#888">${getVal(r.c[22]) || getVal(r.c[7])}, ${getVal(r.c[6])}</span></div>
                        </div></div></div>`).join('');
            document.getElementById('inlineCounter').innerText = rows.length;
        }

        function openModal(rowIndex) {
            const r = rawRows.find(row => row.c[0] && row.c[0].v == rowIndex);
            if(!r) return;
            let detailsHtml = ""; let link = getVal(r.c[16]);
            for(let i=0; i<=22; i++) {
                if(!colLabels[i] || [8,19,20,21,22].includes(i)) continue;
                let val = getVal(r.c[i]);
                if (i === 16 && val.startsWith('http')) detailsHtml += `<div class="detail-box"><span class="label">${colLabels[i].label}</span><a href="${val}" target="_blank" class="link-btn">SZCZEGÓŁY / DETAILS</a></div>`;
                else detailsHtml += `<div class="detail-box"><span class="label">${colLabels[i].label}</span><span>${val || "---"}</span></div>`;
            }
            document.getElementById('modalContent').innerHTML = `<div class="modal-body"><div class="modal-img-col"><img src="${getVal(r.c[23])}">${link ? `<a href="${link}" target="_blank" class="link-btn">SZCZEGÓŁY / DETAILS</a>` : ''}</div><div class="modal-data-col">${detailsHtml}</div></div>`;
            document.getElementById('modalOverlay').style.display = 'flex';
            const url = new URL(window.location); url.searchParams.set('id', rowIndex); window.history.replaceState({}, '', url);
        }

        function closeModalManual() { document.getElementById('modalOverlay').style.display = 'none'; const url = new URL(window.location); url.searchParams.delete('id'); window.history.replaceState({}, '', url); }
        function closeModal(e) { if(e.target.id === 'modalOverlay') closeModalManual(); }
        function applyURLState() { const params = new URLSearchParams(window.location.search); if (params.has('q')) document.getElementById('search').value = params.get('q'); }
        function syncStateToURL() { const url = new URL(window.location); if (document.getElementById('search').value) url.searchParams.set('q', document.getElementById('search').value); else url.searchParams.delete('q'); window.history.replaceState({}, '', url); }
        function updateSort(l) { if(l === 'PL') document.getElementById('sortSelectHE').value = "none"; else document.getElementById('sortSelectPL').value = "none"; filterAndSort(); }

        /* KONIEC KODU WZORCOWEGO - TERAZ IZOLOWANA LOGIKA DASHBOARDU */

        let timelineChart, locChart, mapInitialized = false;

        function switchView(view) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('active', b.id === `btn-${view}`));
            document.body.classList.toggle('stats-active', view === 'stats');
            if(view === 'stats') {
                if(!mapInitialized) {
                    map = L.map('map').setView([50, 20], 4);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(map);
                    mapInitialized = true;
                }
                setTimeout(() => { updateDashboard(); map.invalidateSize(); }, 200);
            }
        }

        function parseDMS(dmsStr) {
            if (!dmsStr) return null;
            const regex = /(\d+)°(\d+)?′?(\d+)?″?([NSEW])/g;
            const parts = []; let match;
            while ((match = regex.exec(dmsStr)) !== null) {
                let deg = parseFloat(match[1]) + (parseFloat(match[2]||0)/60) + (parseFloat(match[3]||0)/3600);
                if (match[4] === 'S' || match[4] === 'W') deg *= -1;
                parts.push(deg);
            }
            return parts.length === 2 ? parts : null;
        }

        function updateDashboard() {
            const currentData = filterAndSort(false); 
            const yearCounts = {};
            currentData.forEach(r => { let y = extractYear(getVal(r.c[5])); if(y > 0) yearCounts[y] = (yearCounts[y] || 0) + 1; });
            const sortedYears = Object.keys(yearCounts).sort();
            
            if(timelineChart) timelineChart.destroy();
            timelineChart = new Chart(document.getElementById('timelineChart'), {
                type: 'bar',
                data: { labels: sortedYears, datasets: [{ label: '', data: sortedYears.map(y => yearCounts[y]), backgroundColor: '#1a1a1a' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false } }, plugins: { legend: { display: false }, tooltip: { callbacks: { label: (ctx) => `Liczba książek: ${ctx.raw}` } } } }
            });

            const locCounts = {};
            currentData.forEach(r => { let l = getVal(r.c[11]) || "Nieznana"; locCounts[l] = (locCounts[l] || 0) + 1; });
            if(locChart) locChart.destroy();
            locChart = new Chart(document.getElementById('locChart'), {
                type: 'pie',
                data: { labels: Object.keys(locCounts), datasets: [{ data: Object.values(locCounts), backgroundColor: ['#1a1a1a', '#444', '#777', '#aaa', '#ccc'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            map.eachLayer(l => { if(l instanceof L.Marker) map.removeLayer(l); });
            currentData.forEach(r => {
                let coords = parseDMS(getVal(r.c[9]));
                if(coords) L.marker(coords).addTo(map).bindPopup(`<b>${getVal(r.c[7])}</b>`);
            });
        }

        init();
    </script></body></html>
