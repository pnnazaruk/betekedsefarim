<!DOCTYPE html><html lang="pl"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Library of Yeshivas Chachmei Lublin </title>
    <link rel="icon" href="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" type="image/png">
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-sankey@0.12.0"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

    <style>
        /* ORYGINALNY STYL WZORCOWY - NIEZMIENIONY ANI JEDEN ZNAK LOGIKI */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #fff; color: #1a1a1a; }
        body { display: flex; flex-direction: column; }
    #main-header {
            flex: 0 0 auto; 
            background: #fff; 
            color: #1a1a1a; 
            padding: 15px 25px;
            display: flex; 
            /* ZMIANA: Standardowy kierunek i rozpychanie elementów na boki */
            flex-direction: row; 
            justify-content: space-between; 
            align-items: center; 
            border-bottom: 2px solid #1a1a1a; 
            z-index: 4000;
        }
        .header-title { font-family: "SBL Hebrew", serif; font-size: 24px; font-weight: bold; direction: rtl; text-align: right; }
        .header-links { display: flex; gap: 20px; font-size: 12px; text-transform: uppercase; font-weight: bold; }
        .header-links a { color: #1a1a1a; text-decoration: none; }

        #app-container { display: flex; flex-direction: row; flex: 1; overflow: hidden; position: relative; }

        #mobile-toggle { 
            display: none; background: #1a1a1a; color: #fff; border: none; 
            padding: 12px; font-weight: bold; width: 100%; text-transform: uppercase; 
            cursor: pointer; z-index: 3500; font-size: 13px;
        }

#provenance-container {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid #1a1a1a;
    width: 100%;
}

/* To jest Twój główny styl dla kontenera grafu */
#provenance-graph-space {
    width: 100%;
    height: 300px; /* Domyślnie dla telefonów */
    background: #fdfdfd;
    border: 1px solid #eee;
    margin-top: 10px;
}

/* Dla urządzeń stacjonarnych nadpisujemy wysokość używając ID */
@media (min-width: 1024px) {
    #provenance-graph-space {
        height: 600px; /* Większy rozmiar na komputerze */
    }
}
.prov-label {
    font-size: 11px;
    font-weight: bold;
    text-transform: uppercase;
    color: #c73848;
}

        #network-graph {
        height: 600px; /* Stała wysokość na desktopie */
        width: 100%;
        background: #ffffff;
        border-radius: 0;
        margin-top: 20px;
        border: 1px solid #eee;
        box-shadow: none;
    }
    @media (max-width: 768px) {
        #network-graph { height: 400px; } /* Niższy graf na telefonach */
    }

/* --- LEKKI SLIDER (Bez ramki, tła i cieni) --- */
.slider-container {
    position: relative;
    width: 100%;
    margin: 15px 0;
    overflow: hidden;
    background: transparent !important;
    border: none !important;
}

.photo-slider-wrapper {
    display: flex;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}
.photo-slider-wrapper img {
    width: 100%;
    flex-shrink: 0;
    height: auto;
    max-height: 400px;
    object-fit: contain;
    cursor: zoom-in;
    border: none !important;
    outline: none !important;
}

/* Styl strzałek - bardziej dyskretne */
.slider-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0, 0, 0, 0.3); /* Bardzo lekki czarny */
    color: white;
    border: none;
    width: 30px;
    height: 30px;
    cursor: pointer;
    z-index: 10;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    transition: background 0.2s;
}

.slider-btn:hover { 
    background: rgba(0, 0, 0, 0.8); 
}

.prev-btn { left: 5px; }
.next-btn { right: 5px; }

/* Lightbox (Pop-up zdjęcia) */
#lightbox-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    z-index: 9999;
    justify-content: center;
    align-items: center;
}

#lightbox-img {
    max-width: 90%;
    max-height: 90%;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}

.lightbox-close {
    position: absolute;
    top: 20px; right: 30px;
    color: white;
    font-size: 40px;
    cursor: pointer;
}

/* Ukrywanie paska przewijania (opcjonalne, dla estetyki) */
.mini-gallery::-webkit-scrollbar {
    height: 4px;
}
.mini-gallery::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 10px;
}

/* Responsywność dla urządzeń mobilnych */
@media (max-width: 768px) {
    .mobile-gallery-container {
        order: 10; /* Przesuwa na sam dół wewnątrz flex-col */
        width: 100%;
        margin-top: 20px;
        border-top: 1px solid #eee;
        padding-top: 10px;
    }
    .gallery-item {
        flex: 0 0 120px; /* Nieco większe na mobile dla łatwiejszego klikania */
        height: 120px;
    }
}

        #sidebar { 
            width: 280px; flex: 0 0 auto; background: #f9f9f9; border-right: 2px solid #1a1a1a; 
            padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; 
            transition: transform 0.3s ease;
        }

        details.facet-container { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 5px; }
        summary.facet-summary { 
            list-style: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: bold; text-transform: uppercase; outline: none;
        }
        summary.facet-summary::-webkit-details-marker { display: none; }
        summary.facet-summary::before { content: '▸'; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] summary.facet-summary::before { transform: rotate(90deg); }

        summary.heb { direction: rtl; font-family: "SBL Hebrew", serif; font-size: 14px; text-transform: none; }
        summary.heb::before { content: none; }
        summary.heb::after { content: '◂'; margin-left: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] summary.heb::after { transform: rotate(-90deg); }

        .active-badge { font-size: 9px; background: #1a1a1a; color: #fff; padding: 0 5px; border-radius: 3px; margin-left: 5px; }
        .facet-inner-content { padding-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .facet-mini-search { width: 100%; padding: 5px; font-size: 12px; border: 1px solid #ccc; box-sizing: border-box; outline: none; margin-bottom: 5px; }

        .facet-list { list-style: none; padding: 0; margin: 0; max-height: 150px; overflow-y: auto; border: 1px solid #eee; background: #fff; display: flex; flex-direction: column; }
        .facet-item { font-size: 12px; padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .facet-item:hover { background: #f5f5f5; }
        .facet-item.active { background: #1a1a1a !important; color: #fff !important; }
        .facet-item.heb { direction: rtl; text-align: right; font-family: "SBL Hebrew", serif; font-size: 14px; }
        .count-pill { font-size: 9px; background: #eee; padding: 2px 5px; border-radius: 10px; color: #333; }
        .active .count-pill { background: #444; color: #fff; }

        .slider-wrapper { padding: 10px 0; }
        .slider-wrapper.heb { direction: rtl; }
        input[type=range] { width: 100%; accent-color: #1a1a1a; }
        .slider-val { font-size: 12px; font-weight: bold; display: flex; justify-content: space-between; margin-top: 5px; }

        #main-content { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .controls { flex: 0 0 auto; background: #fff; padding: 15px 10px; border-bottom: 2px solid #1a1a1a; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }

        .search-wrapper { 
            position: relative; 
            width: 100%; 
        }

        #search { width: 100%; padding: 10px 60px 10px 15px; border: 1px solid #1a1a1a; font-size: 17px; box-sizing: border-box; outline: none; background: #fdfdfd; }
        #inlineCounter { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: bold; color: #aaa; pointer-events: none; }

        .kb-toggle { font-size: 11px; font-weight: bold; text-decoration: underline; cursor: pointer; text-transform: uppercase; color: #555; margin-bottom: 5px; }
        .keyboard { display: none; grid-template-columns: repeat(9, 1fr); gap: 5px; padding: 10px; background: #f0f0f0; border: 1px solid #1a1a1a; margin-top: 5px; }
        .key { background: #fff; border: 1px solid #1a1a1a; padding: 10px 5px; text-align: center; cursor: pointer; font-family: "SBL Hebrew", serif; font-size: 18px; transition: background 0.2s; }
        .key:hover { background: #e0e0e0; }

        .sort-wrapper { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: space-between; width: 100%; }
        .sort-container { display: flex; align-items: center; gap: 8px; font-size: 12px; font-weight: bold; text-transform: uppercase; flex: 1; min-width: 180px; }
        .sort-container.heb { flex-direction: row-reverse; font-family: "SBL Hebrew", serif; font-size: 14px; }
        select { padding: 8px; border: 1px solid #1a1a1a; border-radius: 0; background: #fff; cursor: pointer; font-size: 13px; flex-grow: 1; }

        #container { flex: 1 1 auto; overflow-y: scroll; padding: 15px 10px; box-sizing: border-box; background: #fff; scroll-behavior: smooth; }
        .item-card { border: 1px solid #eee; margin-bottom: 15px; background: #fff; display: flex; flex-direction: column; width: 100%; box-sizing: border-box; transition: all 0.2s ease; cursor: pointer; }
        .item-card:hover { border-color: #1a1a1a; background: #fcfcfc; }
        .item-content { padding: 18px; }
        .row-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .title-pl { font-weight: bold; font-size: 17px; text-transform: uppercase; flex: 1; }
        .title-heb { font-size: 19px; color: #1a1a1a; text-align: right; direction: rtl; flex: 1; font-family: "SBL Hebrew", serif; }
        .author-row { border-top: 1px solid #eee; padding-top: 10px; margin-top: 8px; display: flex; justify-content: space-between; gap: 20px; }
        .column-pl { font-size: 15px; color: #333; flex: 1; display: flex; flex-direction: column; gap: 4px; }
        .column-he { font-size: 16px; color: #222; text-align: right; direction: rtl; flex: 1; display: flex; flex-direction: column; gap: 4px; font-family: "SBL Hebrew", serif; }
.graph-btn {
    background: #fff;
    border: 1px solid #000;
    padding: 5px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.2s;
}
.graph-btn:hover {
    background: #000;
    color: #fff;
}

        #modalOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 5000; }
        #modalWindow { background: #fff; width: 90%; max-width: 800px; max-height: 90%; overflow-y: auto; padding: 30px; position: relative; border: 2px solid #1a1a1a; }
        .close-modal { position: absolute; top: 15px; right: 15px; font-size: 30px; cursor: pointer; border: none; background: none; }
        .modal-body { display: flex; gap: 30px; flex-wrap: wrap; }
        .modal-img-col { flex: 0 0 200px; text-align: center; }
        .modal-img-col img { width: 100%; max-height: 300px; object-fit: contain; border: 1px solid #1a1a1a; margin-bottom: 15px; }
        .modal-data-col { flex: 1; min-width: 300px; }
        .detail-box { border-bottom: 1px solid #eee; padding: 10px 0; }
        .label { font-size: 10px; font-weight: bold; color: #777; text-transform: uppercase; display: block; margin-bottom: 3px; }
        .link-btn { display: inline-block; background: #1a1a1a; color: #fff !important; padding: 10px 20px; font-size: 12px; text-decoration: none; text-transform: uppercase; font-weight: bold; margin-top: 10px; transition: background 0.3s; border: none; cursor: pointer; }
        .link-btn:hover { background: #555; }
        .clear-btn { font-size: 9px; cursor: pointer; text-decoration: underline; color: #666; font-weight: bold; text-transform: uppercase; }
        body.stats-mode {
    overflow-y: auto !important;
}

body.stats-mode #app-container,
body.stats-mode #main-content {
    overflow: visible !important;
    height: auto !important;
}

body.stats-mode #dashboard-view {
    overflow-y: visible !important;
    height: auto !important;
}

@media (max-width: 768px) {
    #mobile-toggle { display: block; }
    #sidebar { position: absolute; left: 0; top: 0; bottom: 0; z-index: 3000; transform: translateX(-100%); box-shadow: 5px 0 15px rgba(0,0,0,0.2); }
    #sidebar.open { transform: translateX(0); width: 85%; }

    html.stats-mode,
    body.stats-mode {
        overflow-y: auto !important; 
        overflow-x: hidden !important;
        height: auto !important;     
        position: relative !important;
    }

    body.stats-mode #app-container,
    body.stats-mode #main-content {
        height: auto !important;     
        min-height: 100vh !important;
        overflow: visible !important; 
        display: block !important;    
        flex: none !important;
    }

    body.stats-mode #dashboard-view {
        height: auto !important;
        overflow: visible !important;
        display: flex !important;
        flex-direction: column !important; 
        padding: 15px !important;
        padding-bottom: 80px !important; 
    }

    body.stats-mode #mobile-toggle {
        display: none !important; 
    }

    /* Adaptacja nagłówka i kart */
    #main-header { flex-direction: column; gap: 10px; padding: 10px; height: auto !important; }
    .header-title { font-size: 18px; text-align: center; }
    .header-links { gap: 5px; justify-content: center; width: 100%; }
    .nav-tab-btn { margin-left: 0; padding: 5px 8px; font-size: 10px; height: 32px; flex: 1; justify-content: center; }

    .row-flex { flex-direction: column; gap: 5px; }
    .title-heb { text-align: left; direction: ltr; } 
    .author-row { flex-direction: column; gap: 10px; }

    /* Układ kart statystyk pod sobą */
.stat-grid {
        display: block !important;
        gap: 0 !important;
        margin: 0 !important;
        padding: 0 !important;
    }
.chart-card {
        width: 100% !important;
        margin: 0 0 20px 0 !important; /* Góra: 0, Boki: 0, Dół: 20px */
        padding: 15px !important;
        box-sizing: border-box;
        border: 1px solid #1a1a1a;
        display: block !important;
    }

#map-container { 
        height: 350px !important;
        width: 100% !important;
        margin: 0 !important; /* Czyścimy margines mapy, bo siedzi w chart-card */
        margin-top: 0;
        touch-action: pan-y !important;
    }
    #dashboard-view {
        padding: 15px !important;
    }
#dashboard-view > :last-child {
        margin-bottom: 80px !important;
    }
}

        /* --- ZMIANY DLA STATYSTYK I PRZYCISKÓW --- */
        .nav-tab-btn { 
            background: none; border: 1px solid #1a1a1a; padding: 8px 15px; cursor: pointer; font-size: 11px; 
            font-weight: bold; text-transform: uppercase; height: 35px; display: inline-flex; align-items: center; 
            margin-left: 10px; color: #1a1a1a; text-decoration: none; transition: background 0.2s ease; box-sizing: border-box;
        }
        .nav-tab-btn:hover { background: #f0f0f0; }
        .nav-tab-btn.active { background: #1a1a1a; color: #fff; }

        /* FIX: Dashboard zajmuje całą szerokość po ukryciu sidebaru */
        body.stats-mode #app-container { display: block !important; }
        body.stats-mode #sidebar, body.stats-mode .controls, body.stats-mode #container { display: none !important; }

        #dashboard-view { display: none; width: 100%; padding: 20px; background: #f9f9f9; flex-direction: column; gap: 20px; box-sizing: border-box; overflow-y: auto; }
        body.stats-mode #dashboard-view { display: flex; }

        .chart-card { background: #fff; border: 1px solid #1a1a1a; padding: 15px; }
        .stat-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; }
        #map-container { height: 400px; width: 100%; border: 1px solid #1a1a1a; }
        .chart-header { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    /*Stylizacja dymka (tooltipa) proweniencji */
        div.vis-tooltip {
            position: absolute;
            visibility: hidden;
            padding: 10px;
            white-space: normal;
            max-width: 250px;
            font-family: "SBL Hebrew", "Segoe UI", serif;
            font-size: 13px;
            background-color: rgba(26, 26, 26, 0.95); /* Ciemne tło z lekką przezroczystością */
            color: #ffffff;
            border-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            z-index: 10000; /* Musi być wyższy niż modal (5000) */
            border: 1px solid #444;
        }
        /* Styl dla linków współoprawnych */
.bound-with-link {
    font-weight: normal;
    color: #1a1a1a; /* Wymuszenie czarnego koloru */
}

.bound-with-link:hover {
    font-weight: bold;
    color: #1a1a1a; /* Pozostaje czarny przy najechaniu */
}
    </style></head><body>

    <header id="main-header">

        <div class="header-links">
        <a href="https://teatrnn.pl/wystawy/biblioteka-jesziwy/" target="_blank" class="nav-tab-btn">O projekcie / About</a>
        <button class="nav-tab-btn active" id="tab-catalog" onclick="switchTab('catalog')">Katalog / Catalog</button>
        <button class="nav-tab-btn" id="tab-stats" onclick="switchTab('stats')">Statystyki / Statistics</button>
        </div>

        <div class="header-title" dir="rtl">בית עקד ספרים בישיבת חכמי לובלין</div>
    </header>

    <button id="mobile-toggle" onclick="toggleSidebar()">☰ Filtry / Filters / מסננים</button>

    <div id="app-container">
        <aside id="sidebar">
            <div class="facet-section">
                <div class="facet-header"><span class="facet-title">Rok / Year</span></div>
                <div class="slider-wrapper">
                    <input type="range" id="yearSlider" min="1500" max="1939" value="1939" oninput="updateYearLabel(this.value); filterAndSort();">
                    <div class="slider-val"><span>1500</span><span id="yearVal">1939</span></div>
                </div>
            </div>

            <div class="facet-section" style="direction: rtl;">
                <div class="facet-header" style="display: flex; flex-direction: row; justify-content: flex-start;">
                    <span class="facet-title heb">שנה</span>
                </div>
                <div class="slider-wrapper heb">
                    <input type="range" id="hebYearSlider" min="5260" max="5700" value="5700" oninput="updateHebYearLabel(this.value); filterAndSort();">
                    <div class="slider-val" style="direction: rtl;"><span>ש"ק</span><span id="hebYearVal">ת"ש</span></div>
                </div>
            </div>

            <div class="facet-section" style="border-top: 1px solid #1a1a1a; padding-top: 10px;">
                <span class="clear-btn" style="text-align: center; display: block;" onclick="clearFacet('all')">Wyczyść wszystko / Reset all / נקה הכל</span>
            </div>

            <details class="facet-container" id="det-author"><summary class="facet-summary">Autor / Author <span class="active-badge" style="display:none">0</span></summary>
                <div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'authorListPL')"><ul id="authorListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-city"><summary class="facet-summary">Miejsce / Place <span class="active-badge" style="display:none">0</span></summary>
                <div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'cityListPL')"><ul id="cityListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-printer"><summary class="facet-summary">Druk / Printer <span class="active-badge" style="display:none">0</span></summary>
                <div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'printerListPL')"><ul id="printerListPL" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-loc"><summary class="facet-summary">Lokalizacja / Location <span class="active-badge" style="display:none">0</span></summary>
                <div class="facet-inner-content"><input type="text" class="facet-mini-search" placeholder="Filtruj..." onkeyup="filterFacetList(this, 'locListPL')"><ul id="locListPL" class="facet-list"></ul></div></details>

            <details class="facet-container" id="det-author-he"><summary class="facet-summary heb">מחבר <span class="active-badge" style="display:none">0</span></summary>
                <div class="facet-inner-content"><input type="text" class="facet-mini-search" dir="rtl" placeholder="סנן..." onkeyup="filterFacetList(this, 'authorListHE')"><ul id="authorListHE" class="facet-list"></ul></div></details>
            <details class="facet-container" id="det-city-he"><summary class="facet-summary heb">עיר <span class="active-badge" style="display:none">0</span></summary>
                <div class="facet-inner-content"><input type="text" class="facet-mini-search" dir="rtl" placeholder="סנן..." onkeyup="filterFacetList(this, 'cityListHE')"><ul id="cityListHE" class="facet-list"></ul></div></details>
        </aside>

        <main id="main-content">
            <div class="controls">
                <div class="search-wrapper">
                    <input type="text" id="search" placeholder="SZUKAJ / SEARCH / חפש..." onkeyup="filterAndSort()">
                    <div id="inlineCounter"></div>
                </div>
                <span class="kb-toggle" onclick="toggleKeyboard()">KLAWIATURA HEBRAJSKA / מקלדת עברית</span>
                <div id="keyboard" class="keyboard">
                    <div class="key" onclick="addChar('ק')">ק</div><div class="key" onclick="addChar('ר')">ר</div><div class="key" onclick="addChar('א')">א</div>
                    <div class="key" onclick="addChar('ט')">ט</div><div class="key" onclick="addChar('ו')">ו</div><div class="key" onclick="addChar('ן')">ן</div>
                    <div class="key" onclick="addChar('ם')">ם</div><div class="key" onclick="addChar('פ')">פ</div><div class="key" onclick="delChar()">←</div>
                    <div class="key" onclick="addChar('ש')">ש</div><div class="key" onclick="addChar('ד')">ד</div><div class="key" onclick="addChar('ג')">ג</div>
                    <div class="key" onclick="addChar('כ')">כ</div><div class="key" onclick="addChar('ע')">ע</div><div class="key" onclick="addChar('י')">י</div>
                    <div class="key" onclick="addChar('ח')">ח</div><div class="key" onclick="addChar('ל')">ל</div><div class="key" onclick="addChar('ך')">ך</div>
                    <div class="key" onclick="addChar('ז')">ז</div><div class="key" onclick="addChar('ס')">ס</div><div class="key" onclick="addChar('ב')">ב</div>
                    <div class="key" onclick="addChar('ה')">ה</div><div class="key" onclick="addChar('נ')">נ</div><div class="key" onclick="addChar('מ')">מ</div>
                    <div class="key" onclick="addChar('צ')">צ</div><div class="key" onclick="addChar('ת')">ת</div><div class="key" onclick="addChar('ץ')">ץ</div>
                </div>
                <div class="sort-wrapper">
                    <div class="sort-container"><span>Sortuj wg / Sort by:</span>
                        <select id="sortSelectPL" onchange="updateSort('PL')">
                            <option value="none">Oryginalna kolejność / Default order</option>
                            <option value="title">Tytuł (A-Z) / Title (A-Z)</option>
                            <option value="author">Autor (A-Z) / Author (A-Z)</option>
                            <option value="year_asc">Rok (Rosnąco) / Year (Ascending)</option>
                            <option value="year_desc">Rok (Malejąco) / Year (Descending)</option>
                        </select>
                    </div>
                    <div class="sort-container heb"><span>:מיין לפי</span>
                        <select id="sortSelectHE" onchange="updateSort('HE')">
                            <option value="none">סדר מקורי</option>
                            <option value="title_he">כותרת</option>
                            <option value="author_he">מחבר</option>
                            <option value="year_asc_he">שנה (מהישן לחדש)</option>
                            <option value="year_desc_he">שנה (מהחדש לישן)</option>
                        </select>
                    </div>
                </div>
            </div>
            <div id="loader" style="padding:20px;">Wczytywanie / Loading...</div>
            <div id="container"></div>

            <div id="dashboard-view">
                <div class="chart-card">
                    <div class="chart-header">Lata wydania książek z biblioteki Jeszywas Chachmej Lublin / Imprint Dates of the Yeshivas Chachmei Lublin Library Volumes</div>
                    <div style="height: 250px;"><canvas id="timelineChart"></canvas></div>
                </div>
                <div class="chart-card">
    <div class="chart-header">
        Relacja pomiędzy pięcioma najczęstszymi autorami a miejscem druku ich książek / 
        Relationship between the five most frequent authors and the place of printing their books
    </div>
    <div id="sankey-container" style="height: 500px; width: 100%; position: relative;">
        <canvas id="sankeyChart"></canvas>
    </div>
</div>
                <div class="stat-grid">
                    <div class="chart-card">
                        <div class="chart-header">Miejsca druku książek z biblioteki Jeszywas Chachmej Lublin / Printing Locations of Books from the Yeshivas Chachmei Lublin Library</div>
                        <div id="map-container"></div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">Obecna lokalizacja książek z biblioteki Jeszywas Chachmej Lublin / Current Location of Books from the Yeshivas Chachmei Lublin Library</div>
                        <div id="chart-loc-container" style="height: 350px;"><canvas id="locChart"></canvas></div>
                    </div>
<div class="chart-card" style="grid-column: 1 / -1; margin-top: 20px; border-radius: 0; position: relative;">
    <div class="chart-header" style="border-radius: 0;">Analiza Relacji / Relations Analysis</div>

    <div style="padding: 15px; background: #fff; border-bottom: 1px solid #000; display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
        <label style="font-size: 14px; font-weight: bold;">Analizuj / Analyze:</label>
        <select id="graph-mode" style="padding: 5px; border: 1px solid #000; background: #fff; cursor: pointer;">
            <option value="author">10 najczęstszych autorów / Most frequent 10 authors</option>
            <option value="printer">5 najczętszych drukarzy / Most frequent 5 printers</option>
        </select>

        <button onclick="updateGraph()" class="graph-btn">Generuj / Generate</button>

        <div style="display: flex; gap: 10px; margin-left: auto; font-size: 12px;">
            <span><span style="color:#f2c635">●</span> Jeszywas Chachmej Lublin / Yeshivas Chachmei Lublin</span>
            <span><span style="color:#c5c9c9">●</span> Tytuł / Title</span>
            <span><span style="color:#678ed6">●</span> Autor / Author</span>
            <span><span style="color:#6abbc4">◆</span> Drukarz / Printer</span>
            <span><span style="color:#c73848">●</span> Miejsce / Place</span>
        </div>
    </div>

    <div id="network-graph" style="height: 650px; background: #fff;"></div>

    <div style="position: absolute; bottom: 10px; left: 10px; font-size: 10px; color: #555; background: rgba(255,255,255,0.8); padding: 5px;">
        PL: Przeciągnij, aby przesunąć. Użyj rolki, by przybliżyć. | EN: Drag to move. Use scroll to zoom.
    </div>
</div>
                </div>
            </div>
        </main>
    </div>

    <div id="modalOverlay" onclick="closeModal(event)"><div id="modalWindow"><button class="close-modal" onclick="closeModalManual()">&times;</button><div id="modalContent" class="modal-body"></div></div></div>

    <script>
        /* POCZĄTEK KODU WZORCOWEGO - NIEZMIENIONY ANI JEDEN ZNAK LOGIKI */
        let rawRows = [];
        let colLabels = [];
        let activeFilters = { city: new Set(), author: new Set(), printer: new Set(), loc: new Set() };
        let sheetId = '1N--MCZSwjbLchUT37i-Ph5TwHoMxqNXUsO_zPngtokg';
        let url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;
        let fuse;
        let isInitialLoad = true;

        function extractYear(s) { if (!s || s === "---") return 0; let match = String(s).match(/\d{4}/); return match ? parseInt(match[0]) : 0; }
        function hebrewYearToNumber(s) { 
            if (!s || s === "---") return 999999; 
            let c = String(s).replace(/[\\\"\'\.\s\(\)\[\]]/g, "").trim(); 
            let v = {'א':1,'ב':2,'ג':3,'ד':4,'ה':5,'ו':6,'ז':7,'ח':8,'ט':9,'י':10,'כ':20,'ך':20,'ל':30,'מ':40,'ם':40,'נ':50,'ן':50,'ס':60,'ע':70,'פ':80,'ף':80,'צ':90,'ץ':90,'ק':100,'ר':200,'ש':300,'ת':400}; 
            let sum = 0; let cleanC = c.match(/[\u0590-\u05FF]/g);
            if (cleanC) { for (let i=0; i < cleanC.length; i++) sum += v[cleanC[i]] || 0; }
            if (sum > 0 && sum < 1000) sum += 5000; return sum || 999999; 
        }
        function numberToHebrewYear(num) {
            let n = parseInt(num); if (n > 5000) n -= 5000;
            let heb = ""; vArr = [400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1], lArr = ['ת','ש','ר','ק','צ','פ','ע','ס','נ','מ','ל','כ','י','ט','ח','ז','ו','ה','ד','ג','ב','א'];
            for(let i=0; i<vArr.length; i++) { while(n >= vArr[i]) { heb += lArr[i]; n -= vArr[i]; } }
            return heb;
        }
async function init() {
    try {
        let r = await fetch(url);
        let t = await r.text();
        let json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
        rawRows = json.table.rows;
        colLabels = json.table.cols;

        // DODANO: Zapisanie danych do zmiennej globalnej dla przycisku "Generuj"
        window.currentData = rawRows; 

        const fuseData = rawRows.map(row => ({ 
            original: row, 
            searchable: row.c.map(cell => getVal(cell)).join(' ') 
        }));
        fuse = new Fuse(fuseData, { keys: ['searchable'], threshold: 0.3, ignoreLocation: true });

        applyURLState();
        filterAndSort();

        // DODANO: Pierwsze uruchomienie grafu (domyślnie autorzy)
        renderNetworkGraph(rawRows, 'author'); 

        document.getElementById('loader').style.display = 'none';
        window.addEventListener('popstate', () => { applyURLState(); filterAndSort(false); });
    } catch (e) { 
        console.error(e); 
    }
}

        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
        function getVal(cell) { return cell && (cell.f || (cell.v !== null ? String(cell.v) : "")) || ""; }
        function isUnknown(val) { let v = val ? val.trim() : ""; return !v || v === "---" || v === "-"; }
        function updateYearLabel(val) { document.getElementById('yearVal').innerText = val; }
        function updateHebYearLabel(val) { document.getElementById('hebYearVal').innerText = numberToHebrewYear(val); }
        function toggleKeyboard() { let k = document.getElementById('keyboard'); k.style.display = k.style.display === 'grid' ? 'none' : 'grid'; }
        function addChar(c) { document.getElementById('search').value += c; filterAndSort(); }
        function delChar() { let s = document.getElementById('search'); s.value = s.value.slice(0,-1); filterAndSort(); }

        function filterFacetList(input, listId) {
            let filter = input.value.toLowerCase();
            let items = document.querySelectorAll(`#${listId} li`);
            items.forEach(li => {
                let span = li.querySelector('span');
                if (span) {
                    let txt = span.innerText.toLowerCase();
                    li.style.display = txt.includes(filter) ? "flex" : "none";
                }
            });
        }

        function clearFacet(type) {
            if (type === 'all') { 
                activeFilters.city.clear(); activeFilters.author.clear(); activeFilters.printer.clear(); activeFilters.loc.clear(); 
                document.getElementById('yearSlider').value = 1939;
                document.getElementById('hebYearSlider').value = 5700;
                updateYearLabel(1939); updateHebYearLabel(5700);
                document.getElementById('search').value = "";
            } else activeFilters[type].clear();
            filterAndSort();
        }

        function toggleFilter(val, type) {
            if (activeFilters[type].has(val)) activeFilters[type].delete(val);
            else activeFilters[type].add(val);
            filterAndSort();
        }

        function filterAndSort(updateURL = true) {
            const term = document.getElementById('search').value.toLowerCase().trim();
            const maxYear = parseInt(document.getElementById('yearSlider').value);
            const maxHebYear = parseInt(document.getElementById('hebYearSlider').value);
            const sPL = document.getElementById('sortSelectPL').value;
            const sHE = document.getElementById('sortSelectHE').value;

            let searchFiltered = (term && fuse) ? fuse.search(term).map(r => r.item.original) : rawRows;

            const filtered = searchFiltered.filter(r => {
                const cityPL = getVal(r.c[7]), authPL = getVal(r.c[3]), prnPL = getVal(r.c[10]), locPL = getVal(r.c[11]);
                const year = extractYear(getVal(r.c[5])), hebYear = hebrewYearToNumber(getVal(r.c[6]));
                const matchYear = (year === 0 || year <= maxYear) && (hebYear === 999999 || hebYear <= maxHebYear);
                const matchCity = activeFilters.city.size === 0 || (isUnknown(cityPL) ? activeFilters.city.has('_UNK_') : activeFilters.city.has(cityPL.trim()));
                const matchAuth = activeFilters.author.size === 0 || (isUnknown(authPL) ? activeFilters.author.has('_UNK_') : activeFilters.author.has(authPL.trim()));
                const matchPrn = activeFilters.printer.size === 0 || (isUnknown(prnPL) ? activeFilters.printer.has('_UNK_') : activeFilters.printer.has(prnPL.trim()));
                const matchLoc = activeFilters.loc.size === 0 || (isUnknown(locPL) ? activeFilters.loc.has('_UNK_') : activeFilters.loc.has(locPL.trim()));
                return matchYear && matchCity && matchAuth && matchPrn && matchLoc;
            });

            const sortVal = sPL !== "none" ? sPL : sHE;
            if(sortVal !== "none") {
                filtered.sort((a, b) => {
                    const norm = (s) => getVal(s).replace(/[\[\]]/g, "").toLowerCase().trim();
                    if (sortVal.includes("year")) {
                        let vA = extractYear(getVal(a.c[5])), vB = extractYear(getVal(b.c[5]));
                        if (sortVal.includes("_he")) { vA = hebrewYearToNumber(getVal(a.c[6])); vB = hebrewYearToNumber(getVal(b.c[6])); }
                        if (vA === 0 || vA === 999999) return 1; if (vB === 0 || vB === 999999) return -1;
                        return sortVal.includes("desc") ? vB - vA : vA - vB;
                    }
                    let i = 1;
                    if (sortVal === 'title_he') i = 2;
                    else if (sortVal === 'author') i = 3;
                    else if (sortVal === 'author_he') i = 4;
                    let valA = norm(a.c[i]), valB = norm(b.c[i]);
                    const isAUnknown = isUnknown(valA), isBUnknown = isUnknown(valB);
                    if (isAUnknown && !isBUnknown) return 1;
                    if (!isAUnknown && isBUnknown) return -1;
                    return valA.localeCompare(valB, sortVal.includes('_he') ? 'he' : 'pl');
                });
            }

            updateFacetsUI(term, maxYear, maxHebYear);
            render(filtered);
            if (updateURL) syncStateToURL();
            if (isInitialLoad) {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('id')) openModal(urlParams.get('id'));
                isInitialLoad = false;
            }
        }

        function updateFacetsUI(term, maxYear, maxHebYear) {
            const counts = { city: {}, author: {}, printer: {}, loc: {} };
            const plToHe = { city: {}, author: {} };
            let searchFiltered = (term && fuse) ? fuse.search(term).map(r => r.item.original) : rawRows;

            searchFiltered.forEach(r => {
                const cityPL = getVal(r.c[7]), authPL = getVal(r.c[3]), prnPL = getVal(r.c[10]), locPL = getVal(r.c[11]);
                const cityHE = getVal(r.c[22]) || cityPL, authHE = getVal(r.c[4]) || authPL;
                const year = extractYear(getVal(r.c[5])), hebYear = hebrewYearToNumber(getVal(r.c[6]));
                if (!((year === 0 || year <= maxYear) && (hebYear === 999999 || hebYear <= maxHebYear))) return;
                const passCity = (activeFilters.author.size === 0 || activeFilters.author.has(isUnknown(authPL)?'_UNK_':authPL.trim())) && (activeFilters.printer.size === 0 || activeFilters.printer.has(isUnknown(prnPL)?'_UNK_':prnPL.trim())) && (activeFilters.loc.size === 0 || activeFilters.loc.has(isUnknown(locPL)?'_UNK_':locPL.trim()));
                const passAuth = (activeFilters.city.size === 0 || activeFilters.city.has(isUnknown(cityPL)?'_UNK_':cityPL.trim())) && (activeFilters.printer.size === 0 || activeFilters.printer.has(isUnknown(prnPL)?'_UNK_':prnPL.trim())) && (activeFilters.loc.size === 0 || activeFilters.loc.has(isUnknown(locPL)?'_UNK_':locPL.trim()));
                const passPrn = (activeFilters.city.size === 0 || activeFilters.city.has(isUnknown(cityPL)?'_UNK_':cityPL.trim())) && (activeFilters.author.size === 0 || activeFilters.author.has(isUnknown(authPL)?'_UNK_':authPL.trim())) && (activeFilters.loc.size === 0 || activeFilters.loc.has(isUnknown(locPL)?'_UNK_':locPL.trim()));
                const passLoc = (activeFilters.city.size === 0 || activeFilters.city.has(isUnknown(cityPL)?'_UNK_':cityPL.trim())) && (activeFilters.author.size === 0 || activeFilters.author.has(isUnknown(authPL)?'_UNK_':authPL.trim())) && (activeFilters.printer.size === 0 || activeFilters.printer.has(isUnknown(prnPL)?'_UNK_':prnPL.trim()));

                if (passCity) { let k = isUnknown(cityPL)?'_UNK_':cityPL.trim(); counts.city[k] = (counts.city[k]||0)+1; plToHe.city[k] = isUnknown(cityPL)?'לא ידוע':cityHE.trim(); }
                if (passAuth) { let k = isUnknown(authPL)?'_UNK_':authPL.trim(); counts.author[k] = (counts.author[k]||0)+1; plToHe.author[k] = isUnknown(authPL)?'לא ידוע':authHE.trim(); }
                if (passPrn) { let k = isUnknown(prnPL)?'_UNK_':prnPL.trim(); counts.printer[k] = (counts.printer[k]||0)+1; }
                if (passLoc) { let k = isUnknown(locPL)?'_UNK_':locPL.trim(); counts.loc[k] = (counts.loc[k]||0)+1; }
            });
            renderFacetList('authorListPL', counts.author, 'author', false, 'Wszystko/ All', 'Nieznany', null);
            renderFacetList('cityListPL', counts.city, 'city', false, 'Wszystko/ All', 'Nieznane', null);
            renderFacetList('printerListPL', counts.printer, 'printer', false, 'Wszystko/ All', 'Nieznany', null);
            renderFacetList('locListPL', counts.loc, 'loc', false, 'Wszystko/ All', 'Nieznana', null);
            renderFacetList('authorListHE', counts.author, 'author', true, 'הכל', 'לא ידוע', plToHe.author);
            renderFacetList('cityListHE', counts.city, 'city', true, 'הכל', 'לא ידוע', plToHe.city);
            Object.keys(activeFilters).forEach(t => { let b = document.querySelector(`#det-${t} .active-badge`); if(b) { b.innerText = activeFilters[t].size; b.style.display = activeFilters[t].size > 0 ? 'inline' : 'none'; } });
        }

        function renderFacetList(id, counts, type, isHeb, allLabel, unkLabel, heMap) {
            const list = document.getElementById(id); let html = `<li class="facet-item ${activeFilters[type].size===0?'active':''}" onclick="clearFacet('${type}')">${allLabel}</li>`;
            Object.keys(counts).sort((a,b) => (isHeb?heMap[a]:a).localeCompare(isHeb?heMap[b]:b, isHeb?'he':'pl')).forEach(k => {
                if(k==='_UNK_') return;
                html += `<li class="facet-item ${activeFilters[type].has(k)?'active':''}" onclick="toggleFilter('${k}', '${type}')"><span>${isHeb?heMap[k]:k}</span><span class="count-pill">${counts[k]}</span></li>`;
            });
            if (counts['_UNK_']) html += `<li class="facet-item ${activeFilters[type].has('_UNK_')?'active':''}" onclick="toggleFilter('_UNK_', '${type}')"><span>${unkLabel}</span><span class="count-pill">${counts['_UNK_']}</span></li>`;
            list.innerHTML = html;
        }

        function render(rows) {
            const container = document.getElementById('container');
            container.innerHTML = rows.map(r => `
                <div class="item-card" onclick="openModal('${r.c[0].v}')">
                    <div class="item-content"><div class="row-flex"><span class="title-pl">${getVal(r.c[1])}</span><span class="title-heb">${getVal(r.c[2])}</span></div>
                        <div class="author-row"><div class="column-pl"><span>${getVal(r.c[3])}</span><span style="font-size:12px;color:#888">${getVal(r.c[7])}, ${getVal(r.c[5])}</span></div>
                            <div class="column-he"><span>${getVal(r.c[4])}</span><span style="font-size:13px;color:#888">${getVal(r.c[22]) || getVal(r.c[7])}, ${getVal(r.c[6])}</span></div>
                        </div></div></div>`).join('');
            document.getElementById('inlineCounter').innerText = rows.length;
        }

        function copyLink(id) {
            const baseUrl = window.location.origin + window.location.pathname;
            const uniqueLink = `${baseUrl}?id=${id}`;
            navigator.clipboard.writeText(uniqueLink).then(() => {
                const btn = document.getElementById('copyBtn');
                btn.innerText = "SKOPIOWANO / COPIED";
                setTimeout(() => btn.innerText = "KOPIUJ / COPY", 2000);
            });
        }

function openModal(rowIndex) {
    // 1. Znalezienie danych wiersza
    if (!rawRows) return;
    const r = rawRows.find(row => row.c[0] && row.c[0].v == rowIndex);
    if (!r) return;

    // Funkcja pomocnicza do znalezienia tytułu po ID (bezpieczna)
    const getTitleById = (id) => {
        const foundRow = rawRows.find(row => row.c[0] && row.c[0].v == id);
        if (foundRow && foundRow.c[1]) return foundRow.c[1].v;
        return "ID " + id;
    };

// --- NOWA LOGIKA: PRZYGOTOWANIE SLIDERA 
    const extraImagesRaw = (r.c[27] && r.c[27].v) ? String(r.c[27].v).trim() : "";
    let galleryHTML = "";
    currentSlide = 0; // Resetujemy stan przy każdym otwarciu modala

if (extraImagesRaw && extraImagesRaw !== "-" && extraImagesRaw !== "") {
        const images = extraImagesRaw.split('|').map(url => url.trim()).filter(Boolean);
        if (images.length > 0) {
            // Dodajemy data-current-slide="0"
galleryHTML = `
    <div class="slider-container" data-current-slide="0">
        ...
        <div class="photo-slider-wrapper">
            ${images.map(imgUrl => `<img src="${imgUrl}" ...>`).join('')}
        </div>
    </div>
`;
        }
    }
    // ---------------------------------------------------------------

    const boundWithRaw = (r.c[26] && r.c[26].v) ? String(r.c[26].v).trim() : "";
    let h = ""; 
    let link = getVal(r.c[16]);
    let boundWithSection = "";

    // 2. Pętla generująca szczegóły (kolumny 0-22)
    for (let i = 0; i <= 22; i++) {
        if (!colLabels[i] || [8, 19, 20, 21, 22].includes(i)) continue;
        let val = getVal(r.c[i]);
        if (!val || val === "---") continue;

        if (val.startsWith('http')) {
            h += `<div class="detail-box"><span class="label">${colLabels[i].label}</span><a href="${val}" target="_blank" class="link-btn">SZCZEGÓŁY / DETAILS</a></div>`;
        } else {
            h += `<div class="detail-box"><span class="label">${colLabels[i].label}</span><span>${val}</span></div>`;
        }
    }

    // 3. Przygotowanie sekcji Współoprawne (Tytuł bez podkreślenia)
    if (boundWithRaw && boundWithRaw !== "-" && boundWithRaw !== "0") {
        const boundIds = boundWithRaw.split(',').map(id => id.trim());
        const boundLinks = boundIds.map(id => {
            const bookTitle = getTitleById(id); 
            return `<a href="./?id=${id}" class="bound-with-link" style="color: #1a1a1a; text-decoration: none; display: block; margin-bottom: 5px;">
                        ${bookTitle}
                    </a>`;
        }).join('');

        boundWithSection = `
            <div class="detail-box">
                <span class="label">Współoprawne / Bound with</span>
                <span>${boundLinks}</span>
            </div>
        `;
    }

    // 4. Logika wstawiania pod sygnaturę
    let finalDetailsHtml = h;
    const callNumberLabel = "Obecna Sygnatura / Current Call number"; 
    
    if (boundWithSection) {
        const regex = new RegExp(`(<div class="detail-box">\\s*<span class="label">${callNumberLabel}</span>.*?</div>)`, 's');
        if (regex.test(h)) {
            finalDetailsHtml = h.replace(regex, `$1${boundWithSection}`);
        } else {
            finalDetailsHtml = h + boundWithSection;
        }
    }

    const copySection = `<div class="detail-box"><span class="label">Link do rekordu / Link to record</span><button id="copyBtn" class="link-btn" onclick="copyLink('${rowIndex}')">KOPIUJ / COPY</button></div>`;

    const provenanceHTML = `
        <div id="provenance-container" style="display:none; margin-top:20px; border-top:1px solid #1a1a1a; padding-top:15px;">
            <span class="prov-label" style="font-weight:bold; font-size:12px;">MAPA PROWENIENCJI / PROVENANCE MAP</span>
            <div id="provenance-graph-space" class="dynamic-graph-height"></div>
        </div>
    `;

    // 5. Renderowanie do HTML (Z uwzględnieniem RWD dla galerii)
    const isMobile = window.innerWidth <= 768;

    document.getElementById('modalContent').innerHTML = `
        <div class="modal-body">
            <div class="modal-img-col">
                <img src="${getVal(r.c[23])}" style="max-width:100%;" onerror="this.src='https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png'">
                ${link ? `<a href="${link}" target="_blank" class="link-btn" style="margin-top:10px; display:block; text-align:center;">SZCZEGÓŁY / DETAILS</a>` : ''}
                
                <div class="gallery-desktop" style="display: ${isMobile ? 'none' : 'block'};">
                    ${galleryHTML}
                </div>
            </div>
            <div class="modal-data-col">
                ${finalDetailsHtml} 
                ${copySection}
                ${provenanceHTML}
                
                <div class="gallery-mobile" style="display: ${isMobile ? 'block' : 'none'}; margin-top: 20px;">
                    ${galleryHTML}
                </div>
            </div>
        </div>
    `;

    // 6. Pokazanie modala i aktualizacja URL
    document.getElementById('modalOverlay').style.display = 'flex';
    const url = new URL(window.location); 
    url.searchParams.set('id', rowIndex); 
    window.history.replaceState({}, '', url);

    // 7. Obsługa grafu proweniencji
    const provText = (r.c[24] && r.c[24].v) ? String(r.c[24].v).trim() : "";
    const provDetails = (r.c[25] && r.c[25].v) ? String(r.c[25].v).trim() : "";

    if (provText && provText !== "-") {
        document.getElementById('provenance-container').style.display = 'block';
        setTimeout(() => {
            if (typeof ProvenanceModule !== 'undefined') {
                ProvenanceModule.init(provText, provDetails, 'provenance-graph-space');
            }
        }, 300);
    }
}

        function closeModalManual() { document.getElementById('modalOverlay').style.display = 'none'; const url = new URL(window.location); url.searchParams.delete('id'); window.history.replaceState({}, '', url); }
        function closeModal(e) { if(e.target.id === 'modalOverlay') closeModalManual(); }
        function syncStateToURL() { const url = new URL(window.location); if (document.getElementById('search').value) url.searchParams.set('q', document.getElementById('search').value); else url.searchParams.delete('q'); window.history.replaceState({}, '', url); }
        function applyURLState() { const p = new URLSearchParams(window.location.search); if (p.has('q')) document.getElementById('search').value = p.get('q'); }
        function updateSort(l) { if(l === 'PL') document.getElementById('sortSelectHE').value = "none"; else document.getElementById('sortSelectPL').value = "none"; filterAndSort(); }

        /* KONIEC KODU WZORCOWEGO - LOGIKA DODATKOWA STATYSTYK */

        let mapInstance, timelineChart, locChart, mapInitialized = false;

function switchTab(mode) {
    document.querySelectorAll('.nav-tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`tab-${mode}`).classList.add('active');

    // Zamykamy sidebar, aby nie blokował widoku na mobile
    document.getElementById('sidebar').classList.remove('open');

    if(mode === 'stats') {
        // Kluczowe: dodajemy klasę do html i body, aby odblokować CSS
        document.body.classList.add('stats-mode');
        document.documentElement.classList.add('stats-mode');

        if(!mapInitialized) {
            const isMobile = window.innerWidth < 768;

            // KONFIGURACJA MAPY DLA MOBILE I PC
            const mapOptions = isMobile ? { 
                dragging: true,           // Pozwalamy na ruch...
                touchZoom: true,          // ...i powiększanie palcami
                tap: true,
                scrollWheelZoom: false,   // Ale wyłączamy scroll kółkiem myszy (by nie psuć scrolla strony)
                // Wymuszenie użycia dwóch palców do przesuwania mapy na telefonie
                // Dzięki temu jeden palec zawsze przewija stronę!
                bounceAtZoomLimits: true
            } : {};

            mapInstance = L.map('map-container', mapOptions).setView([50, 20], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OSM' }).addTo(mapInstance);

            // Specjalny "bezpiecznik" dla mobile:
            if (isMobile) {
                // Informujemy użytkownika (opcjonalnie), że mapę obsługuje się dwoma palcami
                mapInstance.on('focus', () => { mapInstance.scrollWheelZoom.enable(); });
            }

            mapInitialized = true;
        }
        setTimeout(() => { 
            renderStats(); 
            if(mapInstance) mapInstance.invalidateSize(); 
        }, 300);
    } else {
        document.body.classList.remove('stats-mode');
        document.documentElement.classList.remove('stats-mode');
        window.scrollTo(0,0);
    }
}

        function parseDMS(dmsStr) {
            try {
                if (!dmsStr) return null;
                const regex = /(\d+)°(\d+)?′?(\d+)?″?([NSEW])/g;
                const parts = []; let m;
                while ((m = regex.exec(dmsStr)) !== null) {
                    let val = parseFloat(m[1]) + (parseFloat(m[2]||0)/60) + (parseFloat(m[3]||0)/3600);
                    if (m[4] === 'S' || m[4] === 'W') val *= -1;
                    parts.push(val);
                }
                return parts.length === 2 ? parts : null;
            } catch(e) { return null; }
        }

        function renderStats() {
            const data = rawRows; 
            const isMobile = window.innerWidth < 768;

            const years = {};
            data.forEach(r => { let y = extractYear(getVal(r.c[5])); if(y > 0) years[y] = (years[y]||0) + 1; });
            const sortedYears = Object.keys(years).sort();
            if(timelineChart) timelineChart.destroy();
            timelineChart = new Chart(document.getElementById('timelineChart'), {
                type: 'bar',
                data: { labels: sortedYears, datasets: [{ label: 'Książki / Books', data: sortedYears.map(y => years[y]), backgroundColor: '#1a1a1a' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
// --- LOGIKA SANKEY DIAGRAM (v7 - Całkowita unifikacja barw i brak warstw) ---
            const authCountsS = {};
            data.forEach(r => {
                let a = getVal(r.c[3]);
                if (!isUnknown(a)) authCountsS[a] = (authCountsS[a] || 0) + 1;
            });

            const top5SankeyAuth = Object.entries(authCountsS)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(e => e[0]);

            const sankeyFlows = [];
            const citiesInSankey = new Set();
            data.forEach(r => {
                let auth = getVal(r.c[3]);
                let city = getVal(r.c[7]) || "Nieznane / Unknown";
                if (top5SankeyAuth.includes(auth)) {
                    sankeyFlows.push({ from: auth, to: city, flow: 1 });
                    citiesInSankey.add(city);
                }
            });

            const aggregatedFlows = Object.values(sankeyFlows.reduce((acc, curr) => {
                const key = curr.from + "|" + curr.to;
                if (!acc[key]) acc[key] = { ...curr };
                else acc[key].flow += 1;
                return acc;
            }, {}));

  // 1. Definiujemy kolory z kanałem Alpha (identycznym jak późniejsze alpha linii)
            const sankeyPalette = {
                [top5SankeyAuth[0]]: 'rgba(93, 173, 226, 0.8)', // Przytłumiony niebieski
                [top5SankeyAuth[1]]: 'rgba(235, 152, 78, 0.8)', // Przytłumiony pomarańczowy
                [top5SankeyAuth[2]]: 'rgba(236, 112, 99, 0.8)', // Przytłumiony malinowy
                [top5SankeyAuth[3]]: 'rgba(72, 201, 176, 0.8)', // Przytłumiony turkusowy
                [top5SankeyAuth[4]]: 'rgba(244, 208, 63, 0.8)'  // Przytłumiony żółty
            };

            const greyNode = 'rgba(189, 195, 199, 0.8)'; // Szary dla miast

            if (window.sankeyInstance) window.sankeyInstance.destroy();
            const ctxSankey = document.getElementById('sankeyChart').getContext('2d');

            window.sankeyInstance = new Chart(ctxSankey, {
                type: 'sankey',
                data: {
                    datasets: [{
                        data: aggregatedFlows,
                        // WYMUSZENIE KOLORÓW WĘZŁÓW - używamy RGBA dla spójności
                        colorNodes: (context) => {
                            const name = context.node.id;
                            return sankeyPalette[name] ? sankeyPalette[name] : greyNode;
                        },
                        // KOLORY LINII
                        colorFrom: (c) => sankeyPalette[c.dataset.data[c.dataIndex].from],
                        colorTo: (c) => {
                            const active = c.chart.getActiveElements();
                            if (active.length > 0 && active[0].index === c.dataIndex) {
                                return sankeyPalette[c.dataset.data[c.dataIndex].from];
                            }
                            return greyNode;
                        },
                        colorMode: 'gradient',
                        nodeColorMode: 'fixed',

                        // KLUCZOWE: Ustawiamy alpha na 1, bo przezroczystość mamy w RGBA
                        alpha: 1, 
                        hoverAlpha: 1,

                        borderWidth: 0,
                        nodeWidth: 15,
                        nodePadding: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 26, 0.9)',
                            callbacks: {
                                label: (c) => {
                                    const d = c.dataset.data[c.dataIndex];
                                    return ` ${d.from} → ${d.to}: ${d.flow}`;
                                }
                            }
                        }
                    }
                }
            });
// Słupki poziome (Lokalizacje) - Paleta Modern Archive
const locs = {};
            data.forEach(r => { 
                let rawVal = getVal(r.c[11]);
                // Usuwamy zbędne spacje i zamieniamy na małe litery do testu
                let cleanVal = rawVal ? rawVal.trim() : "";
                let testVal = cleanVal.toLowerCase();

                let finalLabel;
                // Jeśli komórka spełnia warunek "nieznana" (pusta, myślnik, lub zawiera frazę unknown/nieznan)
                if (isUnknown(cleanVal) || testVal.includes('unknown') || testVal.includes('nieznan')) {
                    finalLabel = "Nieznana / Unknown";
                } else {
                    finalLabel = cleanVal; // Zachowaj oryginalną pisownię z Excela
                }

                if (finalLabel) {
                    locs[finalLabel] = (locs[finalLabel] || 0) + 1; 
                }
            });

            const locData = Object.entries(locs).sort((a, b) => b[1] - a[1]);
            const labels = locData.map(d => d[0]);
            const values = locData.map(d => d[1]);

            if(locChart) locChart.destroy();

            // Dynamiczne dostosowanie wysokości kontenera na mobile
            if(isMobile) document.getElementById('chart-loc-container').style.height = (labels.length * 40) + "px";

            locChart = new Chart(document.getElementById('locChart'), {
                type: 'bar',
                data: { 
                    labels: labels, 
                    datasets: [{ 
                        data: values, 
                        backgroundColor: ['#2c3e50', '#5a6a7a', '#7f8c8d', '#95a5a6', '#bdc3c7', '#d5dbdb', '#e5e8e8'],
                        borderRadius: 4
                    }] 
                },
options: { 
                indexAxis: 'y',
                responsive: true, 
                maintainAspectRatio: false, 
                layout: {
                    padding: {
                        left: 10 // Subtelny margines od krawędzi
                    }
                },
                interaction: {
                    mode: 'y',
                    intersect: false
                },
                plugins: { 
                    legend: { display: false },
                    tooltip: { 
                        enabled: true,
                        backgroundColor: 'rgba(26, 26, 26, 0.9)',
                        padding: 10,
                        // To wymusi pokazanie PEŁNEJ nazwy w dymku, nawet jeśli na osi jest skrócona
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            }
                        }
                    }
                },
                scales: {
                    x: { 
                        beginAtZero: true, 
                        grid: { display: false },
                        ticks: { stepSize: 50 } 
                    },
                    y: { 
                        grid: { display: false },
                        ticks: { 
                            autoSkip: false, 
                            font: { size: isMobile ? 9 : 11, weight: 'bold' }, 
                            color: '#1a1a1a',
                            // FUNKCJA SKRACAJĄCA TEKST - agresywniejsza na mobile
                            callback: function(value) {
                                let label = this.getLabelForValue(value);
                                const maxLength = isMobile ? 18 : 35; 
                                if (label.length > maxLength) {
                                    return label.substring(0, maxLength) + '...';
                                }
                                return label;
                            }
                        }
                    }
                }
            }
            });
            mapInstance.eachLayer(l => { if(l instanceof L.Marker) mapInstance.removeLayer(l); });
            const cities = {};
            data.forEach(r => {
                let name = getVal(r.c[7]), coords = parseDMS(getVal(r.c[9]));
                if(coords) {
                    let key = coords.join(',');
                    if(!cities[key]) cities[key] = { pos: coords, name: name, count: 0 };
                    cities[key].count++;
                }
            });
            Object.values(cities).forEach(c => {
                L.marker(c.pos).addTo(mapInstance).bindPopup(`<b>${c.name}</b><br>Książek / Books: ${c.count}`);
            });
            renderNetworkGraph(data); // <--- TUTAJ TO POWINNO BYĆ
        }
        let networkInstance = null;
function renderNetworkGraph(data, mode = 'author') {
            const container = document.getElementById('network-graph');
    if (networkInstance !== null) {
        networkInstance.destroy();
        networkInstance = null;
    }

    const isAuthorMode = mode === 'author';
const categoryIndex = isAuthorMode ? 3 : 10; // 3 to autor, 10 to drukarz
const limit = isAuthorMode ? 10 : 5;

const counts = {};
data.forEach(r => {
    let val = getVal(r.c[categoryIndex]);
    if (val && val !== '-' && !val.toLowerCase().includes('brak')) {
        counts[val] = (counts[val] || 0) + 1;
    }
});

const topItems = Object.entries(counts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, limit)
    .map(e => e[0]);

            const nodes = new vis.DataSet();
            const edges = new vis.DataSet();
            const addedNodes = new Set();

            // Centralny punkt
nodes.add({
    id: 'center',
    label: 'Jeszywas Chachmej Lublin',
    title: 'Jeszywas Chachmej Lublin', // Dymek
    shape: 'dot',
    size: 80, // Zwiększony rozmiar
borderWidth: 0, // Całkowite usunięcie ramki
    borderWidthSelected: 0, // Usunięcie ramki również po kliknięciu
    color: {
        background: '#f2c635',
        border: '#f2c635', // Dla pewności ustawiamy kolor ramki identyczny z tłem
        highlight: {
            background: '#f2c635',
            border: '#f2c635'
        }
    },
chosen: {
        node: function(values, id, selected, hovering) {
            if (hovering) {
                values.color = '#f2c635'; // Zmuszamy do zachowania oryginalnego koloru
                values.borderWidth = 0;
            }
        }
    },
    font: { size: 18, weight: 'bold' }
});
addedNodes.add('center');

            data.forEach(r => {
    const currentItem = getVal(r.c[categoryIndex]);
    if (topItems.includes(currentItem)) {
        const title = getVal(r.c[1]);
        const author = getVal(r.c[3]);
        const city = getVal(r.c[7]);
        const printer = getVal(r.c[10]);
        const year = getVal(r.c[5]);
        const bookId = 'book_' + Math.random().toString(36).substr(2, 9);

        // TYTUŁY - Pomarańczowe koła z podpisem
        nodes.add({
            id: bookId,
            label: title.substring(0, 15) + '...', // Podpis pod kołem
            title: 'Tytuł / Title: ' + title, // Dymek
            shape: 'dot',
            size: 20,
            color: '#c5c9c9' // Orange
        });

edges.add({ 
            from: 'center', 
            to: bookId, 
            color: {
                color: '#c5c9c9',      // Kolor linii
                highlight: '#c5c9c9',  // Kolor po kliknięciu
                hover: '#c5c9c9',      // Kolor po najechaniu
                inherit: false         // WYMAGANE: wyłącza dziedziczenie koloru z Jeszywy
            },
    chosen: {
        edge: function(values, id, selected, hovering) {
            if (hovering) {
                values.width = 1; // Zapobiega pogrubieniu linii przy najechaniu
            }
        }
    },
            length: 100
        });

        // AUTORZY - Niebieskie koła z podpisem
        if (author && author !== '-') {
            if (!addedNodes.has(author)) {
                nodes.add({ 
                    id: author, 
                    label: author, // Podpis pod kołem
                    title: 'Autor / Author: ' + author, // Dymek
                    shape: 'dot', 
                    size: (isAuthorMode ? 25 : 15),
                    color: '#678ed6' // Blue
                });
                addedNodes.add(author);
            }
           edges.add({ 
    from: bookId, 
    to: author, 
    color: '#678ed6', 
    length: 250 // Dłuższa linia wypychająca autorów dalej
});
        }

        // DRUKARZ - Turkusowy rąb (diamond) z podpisem
        if (printer && printer !== '-') {
            if (!addedNodes.has(printer)) {
                nodes.add({ 
                    id: printer, 
                    label: printer, // Podpis pod rąbem
                    title: 'Drukarz / Printer: ' + printer, // Dymek
                    shape: 'diamond', 
                    size: (isAuthorMode ? 15 : 30), 
                    color: '#6abbc4' // Turquoise
                });
                addedNodes.add(printer);
            }
            edges.add({ 
                from: bookId, 
                to: printer, 
                color: '#6abbc4',
                title: 'Rok wydania / Year: ' + year // Dymek na linii
            });
        }

        // MIASTA - Najmniejsze czerwone koła
        if (city && city !== '-') {
            if (!addedNodes.has(city)) {
                nodes.add({ 
                    id: city, 
                    label: city, // Podpis pod kołem
                    title: 'Miejsce / Place: ' + city, // Dymek
                    shape: 'dot', 
                    size: 12, // Najmniejsze
                    color: '#c73848' // Red
                });
                addedNodes.add(city);
            }
           edges.add({ 
    from: bookId, 
    to: city, 
    dashes: true, 
    color: '#c73848', 
    length: 350 // Miasta będą w najbardziej zewnętrznym kręgu
});
        }
    }
});

            const graphData = { nodes: nodes, edges: edges };
const options = {
    interaction: { hover: true, tooltipDelay: 200 },
    physics: { 
        stabilization: { iterations: 150 },
        barnesHut: { 
            gravitationalConstant: -5000, // Silniejsze odpychanie punktów
            springConstant: 0.04,         // Elastyczność sprężyn
            springLength: 200             // Domyślna baza długości
        }
    }
};
            networkInstance = new vis.Network(container, graphData, options);
        }
        function updateGraph() {
    const mode = document.getElementById('graph-mode').value;
    if (window.currentData) {
        renderNetworkGraph(window.currentData, mode);
    }
}
// MODUŁ PROWENIENCJI - LOGIKA CELU (DESTINATION-BASED)
const ProvenanceModule = {
    instance: null,

    init: function(text, detailsText, containerId) {
        const container = document.getElementById(containerId);
        if (!containerId) return;
        if (!container || !text || text === "-") {
            if (container) container.innerHTML = "";
            return;
        }

        if (this.instance) { 
            this.instance.destroy(); 
            this.instance = null; 
        }

        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        
        // Rozbijamy opisy z kolumny Z
        const detailsArray = detailsText ? detailsText.split('|').map(d => d.trim()) : [];
        const parts = text.split(/([>|])/g).map(p => p.trim()).filter(p => p !== "");
        
        let lastNodeId = null;
        let nodeIndex = 0;
        let nodeCounter = 0; // Licznik pudełek (węzłów)

        parts.forEach((part, index) => {
            if (part === ">" || part === "|") return;

            const actionMatch = part.match(/\(([^)]+)\)$/);
            const currentAction = actionMatch ? actionMatch[1] : ""; 
            const cleanContent = part.replace(/\s*\([^)]+\)$/, "").trim();
            
            let nodeColor = "#2B7CE9";
            if (currentAction.match(/Grabież|Loot/i)) nodeColor = "#c73848";
            if (currentAction.match(/Dar|Donation/i)) nodeColor = "#28a745";

            const nodeId = nodeIndex++;
            
            // 1. Pobieramy opis z tablicy
            let currentTooltip = detailsArray[nodeCounter] || "";

            // 2. Przygotowujemy obiekt węzła BEZ dymka
            const nodeData = {
                id: nodeId,
                label: cleanContent.replace(/:/g, '\n'),
                shape: 'box',
                shapeProperties: { borderRadius: 0 },
                margin: 10,
                color: { background: '#fff', border: nodeColor },
                font: { size: 12, multi: true, align: 'center' },
                borderWidth: 2
            };

            // 3. KLUCZOWY WARUNEK: Jeśli to nie jest "0!" i nie jest puste, dodaj dymek
            if (currentTooltip !== "0!" && currentTooltip.trim() !== "") {
                nodeData.title = currentTooltip;
            }

            // 4. Dodajemy gotowy obiekt do zbioru węzłów
            nodes.add(nodeData);

            // --- Logika połączeń (edges) pozostaje bez zmian ---
            if (lastNodeId !== null) {
                const prevSeparator = parts[index - 1];
                if (prevSeparator === ">") {
                    edges.add({
                        from: lastNodeId,
                        to: nodeId,
                        label: currentAction,
                        arrows: 'to',
                        color: { color: nodeColor, opacity: 0.8 },
                        font: { size: 10, background: '#ffffff', strokeWidth: 0 }
                    });
                } else if (prevSeparator === "|") {
                    edges.add({
                        from: lastNodeId,
                        to: nodeId,
                        arrows: '',
                        dashes: true,
                        color: { color: '#c2c0c0', opacity: 0.4 },
                        label: "" 
                    });
                }
            }
            lastNodeId = nodeId;
            nodeCounter++; // Zwiększamy licznik po dodaniu każdego węzła
        });

        const options = {
            physics: { 
                enabled: true, 
                solver: 'repulsion', 
                repulsion: { nodeDistance: 250, centralGravity: 0.1 } 
            },
            interaction: { 
                dragNodes: true, 
                zoomView: true, 
                dragView: true,
                hover: true, // Wymagane dla dymków
                selectConnectedEdges: false,
                tooltipDelay: 300 // Dymek pojawi się po 0.3s najechania
            },
            nodes: {
                chosen: {
                    node: function(values, id, selected, hovering) {
                        values.borderWidth = 3; // Tylko lekkie pogrubienie ramki przy kliknięciu
                    }
                }
            },
            edges: {
                hoverWidth: 0,     // Linia nie grubnie przy najechaniu
                selectionWidth: 0, // Linia nie grubnie przy kliknięciu
                chosen: {
                    edge: function(values, id, selected, hovering) {},
                    label: function(values, id, selected, hovering) {}
                }
            }
        };

        this.instance = new vis.Network(container, { nodes, edges }, options);
    }
};
    // Globalna zmienna zainicjowana raz
let currentSlide = 0;

function moveSlide(direction, btnElement) {
    const container = btnElement.closest('.slider-container');
    // ZMIEŃ 'slider-wrapper' na 'photo-slider-wrapper'
    const wrapper = container.querySelector('.photo-slider-wrapper');
    const slides = wrapper.querySelectorAll('img');
    
    let currentIdx = parseInt(container.getAttribute('data-current-slide') || "0");
    currentIdx = (currentIdx + direction + slides.length) % slides.length;
    
    container.setAttribute('data-current-slide', currentIdx);
    wrapper.style.transform = `translateX(-${currentIdx * 100}%)`;
}
        // Funkcja tworząca Lightbox przy pierwszym kliknięciu
function openLightbox(src) {
    let overlay = document.getElementById('lightbox-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'lightbox-overlay';
        overlay.innerHTML = `
            <span class="lightbox-close">&times;</span>
            <img id="lightbox-img" src="">
        `;
        document.body.appendChild(overlay);
        
        // Zamknij po kliknięciu w tło lub krzyżyk
        overlay.onclick = function(e) {
            if (e.target.id !== 'lightbox-img') overlay.style.display = 'none';
        };
    }
    document.getElementById('lightbox-img').src = src;
    overlay.style.display = 'flex';
}
        init();
    </script></body></html>






