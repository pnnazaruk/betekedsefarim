<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title> Library of Yeshivas Chachmei Lublin </title>
        <link rel="icon" href="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" type="image/png">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #fff; color: #1a1a1a; }
        body { display: flex; flex-direction: row; } /* Zmiana na rzędy dla paska bocznego */

        /* PASEK BOCZNY */
        #sidebar { 
            width: 280px; flex: 0 0 auto; background: #f9f9f9; border-right: 2px solid #1a1a1a; 
            padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; gap: 25px; 
        }
        .facet-title { font-size: 11px; font-weight: bold; text-transform: uppercase; color: #1a1a1a; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; display: block; }
        
        /* FILTR LAT */
        .range-container { padding: 0 10px; }
        #yearRange { width: 100%; margin: 10px 0; accent-color: #1a1a1a; }
        .range-labels { display: flex; justify-content: space-between; font-size: 12px; font-weight: bold; }

        /* LISTA MIAST */
        .city-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .city-item { 
            font-size: 13px; padding: 6px 8px; cursor: pointer; display: flex; justify-content: space-between; 
            transition: background 0.2s; border-bottom: 1px solid #eee;
        }
        .city-item:hover { background: #eee; }
        .city-item.active { background: #1a1a1a; color: #fff; }
        .city-count { font-size: 10px; opacity: 0.6; font-weight: bold; }

        /* GŁÓWNA TREŚĆ */
        #main { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; }
        .controls { flex: 0 0 auto; background: #fff; padding: 15px 10px; border-bottom: 2px solid #1a1a1a; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .search-wrapper { position: relative; width: 100%; }
        #search { width: 100%; padding: 15px 60px 15px 15px; border: 2px solid #1a1a1a; border-radius: 0; font-size: 17px; box-sizing: border-box; outline: none; }
        #inlineCounter { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 11px; font-weight: bold; color: #aaa; pointer-events: none; }
        #container { flex: 1 1 auto; overflow-y: scroll; padding: 15px; background: #fff; position: relative; scroll-behavior: smooth; }

        /* KARTY REKORDÓW */
        .item-card { border: 2px solid #1a1a1a; margin-bottom: 15px; background: #fff; display: flex; flex-direction: column; transition: 0.2s; }
        .item-card:hover { background: #fcfcfc; box-shadow: 4px 4px 0px rgba(0,0,0,1); transform: translate(-2px, -2px); }
        .item-content { padding: 18px; cursor: pointer; }
        .row-flex { display: flex; justify-content: space-between; align-items: flex-start; gap: 15px; }
        .title-pl { font-weight: bold; font-size: 17px; text-transform: uppercase; }
        .title-heb { font-size: 19px; text-align: right; font-family: "SBL Hebrew", serif; }
        .author-row { border-top: 1px solid #eee; padding-top: 10px; margin-top: 8px; display: flex; justify-content: space-between; font-size: 14px; }
        .column-he { font-family: "SBL Hebrew", serif; text-align: right; font-size: 16px; }
        .details-label-wrapper { display: flex; justify-content: space-between; margin-top: 15px; border-top: 1px solid #f0f0f0; padding-top: 8px; font-size: 11px; font-weight: bold; color: #999; }
        .item-details { display: none; padding: 20px; background: #f9f9f9; border-top: 2px solid #1a1a1a; }
        .details-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .details-image img { width: 150px; border: 1px solid #1a1a1a; }
        .detail-box { border-bottom: 1px solid #eee; padding-bottom: 4px; margin-bottom: 10px; }
        .label { font-size: 10px; font-weight: bold; color: #777; text-transform: uppercase; display: block; }
        .link-btn { display: inline-block; background: #1a1a1a; color: #fff; padding: 6px 12px; font-size: 10px; text-decoration: none; margin-top: 5px; }

        .kb-toggle { font-size: 11px; font-weight: bold; text-decoration: underline; cursor: pointer; color: #555; }
        .keyboard { display: none; grid-template-columns: repeat(9, 1fr); gap: 5px; background: #f0f0f0; padding: 10px; border: 2px solid #1a1a1a; dir: rtl; margin-bottom: 10px; }
        .key { background: #fff; border: 1px solid #1a1a1a; padding: 10px 5px; text-align: center; cursor: pointer; font-family: "SBL Hebrew", serif; }
        
        #backToTop { position: fixed; bottom: 20px; right: 20px; background: #1a1a1a; color: #fff; width: 40px; height: 40px; border: none; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 2000; font-size: 20px; }
        #loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-style: italic; }
    </style>
</head>
<body>
    <div id="sidebar">
        <div>
            <span class="facet-title">Rok wydania / Year</span>
            <div class="range-container">
                <div class="range-labels"><span id="minLabel">1500</span><span id="maxLabel">1939</span></div>
                <input type="range" id="yearRange" min="1500" max="1939" value="1939" oninput="filterAndSort()">
                <div style="font-size: 10px; color: #666; text-align: center;">Przesuń, aby ustawić rok maksymalny</div>
            </div>
        </div>

        <div>
            <span class="facet-title">Miasto / City</span>
            <ul id="cityFacet" class="city-list">
                </ul>
        </div>
    </div>

    <div id="main">
        <div class="controls">
            <div class="search-wrapper">
                <input type="text" id="search" placeholder="SZUKAJ / SEARCH / חפש..." onkeyup="filterAndSort()">
                <div id="inlineCounter"></div>
            </div>
            <span class="kb-toggle" onclick="toggleKeyboard()">Klawiatura hebrajska / מקלדת עברית</span>
            <div id="keyboard" class="keyboard">
                </div>
            <div style="display:flex; gap:10px;">
                <select id="sortSelectPL" onchange="updateSort('PL')" style="padding:8px; border:1px solid #1a1a1a; flex:1;">
                    <option value="none">Sortuj / Sort</option>
                    <option value="title">Tytuł / Title</option>
                    <option value="year">Rok / Year</option>
                </select>
            </div>
        </div>
        <div id="loader">Wczytywanie / Loading...</div>
        <div id="container" onscroll="handleScroll()"></div>
    </div>

    <button id="backToTop" onclick="scrollToTop()">↑</button>

    <script>
        var rawRows = [];
        var colLabels = [];
        var selectedCity = null;
        var sheetId = '1N--MCZSwjbLchUT37i-Ph5TwHoMxqNXUsO_zPngtokg';
        var url = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/gviz/tq?tqx=out:json';

        async function init() {
            try {
                var r = await fetch(url);
                var t = await r.text();
                var json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
                rawRows = json.table.rows;
                colLabels = json.table.cols;
                
                generateCityFacets();
                filterAndSort();
                
                document.getElementById('loader').style.display = 'none';
            } catch (e) { console.error(e); }
        }

        function getVal(r, i) {
            if (!r || !r.c || !r.c[i]) return "";
            return r.c[i].f ? r.c[i].f : (r.c[i].v !== null ? String(r.c[i].v) : "");
        }

        function generateCityFacets() {
            var cityCounts = {};
            rawRows.forEach(r => {
                var city = getVal(r, 7).trim(); // Kolumna H (indeks 7)
                if (city && city !== "---") {
                    cityCounts[city] = (cityCounts[city] || 0) + 1;
                }
            });

            var sortedCities = Object.keys(cityCounts).sort();
            var list = document.getElementById('cityFacet');
            list.innerHTML = `<li class="city-item active" onclick="selectCity(null, this)">Wszystkie / All</li>`;
            
            sortedCities.forEach(city => {
                var li = document.createElement('li');
                li.className = 'city-item';
                li.innerHTML = `<span>${city}</span><span class="city-count">${cityCounts[city]}</span>`;
                li.onclick = function() { selectCity(city, this); };
                list.appendChild(li);
            });
        }

        function selectCity(city, el) {
            selectedCity = city;
            document.querySelectorAll('.city-item').forEach(li => li.classList.remove('active'));
            el.classList.add('active');
            filterAndSort();
        }

        function filterAndSort() {
            var term = document.getElementById('search').value.toLowerCase();
            var maxYear = parseInt(document.getElementById('yearRange').value);
            document.getElementById('maxLabel').innerText = maxYear;

            var filtered = rawRows.filter(r => {
                if (!r || !r.c || !r.c[1]) return false;
                
                var year = parseInt(getVal(r, 5).replace(/\\D/g, '')) || 0;
                var city = getVal(r, 7).trim();
                var textMatch = r.c.some(c => c && String(c.v).toLowerCase().includes(term));
                
                var yearMatch = (year === 0 || year <= maxYear);
                var cityMatch = !selectedCity || city === selectedCity;

                return textMatch && yearMatch && cityMatch;
            });

            document.getElementById('inlineCounter').innerText = filtered.length;
            render(filtered);
        }

        function render(rows) {
            var container = document.getElementById('container');
            container.innerHTML = "";
            rows.forEach(r => {
                var card = document.createElement('div');
                card.className = 'item-card';
                card.innerHTML = `
                    <div class="item-content" onclick="toggleDetails(this)">
                        <div class="row-flex">
                            <span class="title-pl">${getVal(r, 1)}</span>
                            <span class="title-heb">${getVal(r, 2)}</span>
                        </div>
                        <div class="author-row">
                            <span>${getVal(r, 3)} | ${getVal(r, 7)} | ${getVal(r, 5)}</span>
                            <span class="column-he">${getVal(r, 4)} | ${getVal(r, 6)}</span>
                        </div>
                    </div>
                    <div class="item-details">
                        <div class="details-container">
                            <div class="details-image"><img src="${getVal(r, 23)}"></div>
                            <div class="details-data">
                                <div class="detail-box"><span class="label">Sygnatura</span>${getVal(r, 0)}</div>
                                <div class="detail-box"><span class="label">Uwagi</span>${getVal(r, 15)}</div>
                                <a href="${getVal(r, 16)}" target="_blank" class="link-btn">ZOBACZ / SEE</a>
                            </div>
                        </div>
                    </div>`;
                container.appendChild(card);
            });
        }

        function toggleDetails(el) {
            var details = el.nextElementSibling;
            details.style.display = details.style.display === 'block' ? 'none' : 'block';
        }

        // Dodatkowe funkcje obsługi (scroll, keyboard itd.)
        function scrollToTop() { document.getElementById('container').scrollTo({top: 0, behavior: 'smooth'}); }
        function handleScroll() { var c = document.getElementById('container'); document.getElementById('backToTop').style.display = c.scrollTop > 300 ? "flex" : "none"; }
        function toggleKeyboard() { var k = document.getElementById('keyboard'); k.style.display = k.style.display === 'grid' ? 'none' : 'grid'; }
        
        init();
    </script>
</body>
</html>
