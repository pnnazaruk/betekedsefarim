<!DOCTYPE html><html lang="pl"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Library of Yeshivas Chachmei Lublin - Accordion Test </title>
    <link rel="icon" href="https://teatrnn.pl/files/websites/wystawy/Jesziwa/aukcje/bes.png" type="image/png">
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Segoe UI", Roboto, Arial, sans-serif; background: #fff; color: #1a1a1a; }
        body { display: flex; flex-direction: column; }

        #main-header { flex: 0 0 auto; background: #fff; padding: 15px 25px; display: flex; flex-direction: row-reverse; justify-content: space-between; align-items: center; border-bottom: 2px solid #1a1a1a; z-index: 4000; }
        .header-title { font-family: "SBL Hebrew", serif; font-size: 24px; font-weight: bold; direction: rtl; }
        .header-links { display: flex; gap: 20px; font-size: 12px; text-transform: uppercase; font-weight: bold; }
        .header-links a { color: #1a1a1a; text-decoration: underline; }

        #app-container { display: flex; flex-direction: row; flex: 1; overflow: hidden; position: relative; }

        #sidebar { 
            width: 280px; flex: 0 0 auto; background: #f9f9f9; border-right: 2px solid #1a1a1a; 
            padding: 20px; box-sizing: border-box; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; 
        }

        /* STYL AKORDEONU */
        details.facet-container { border-bottom: 1px solid #ccc; padding-bottom: 10px; margin-bottom: 5px; }
        summary.facet-summary { 
            list-style: none; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-size: 11px; font-weight: bold; text-transform: uppercase; outline: none;
        }
        summary.facet-summary::-webkit-details-marker { display: none; }
        summary.facet-summary::before { content: '▸'; margin-right: 8px; transition: transform 0.2s; display: inline-block; }
        details[open] summary.facet-summary::before { transform: rotate(90deg); }

        .facet-inner-content { padding-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        /* WYSZUKIWARKA WEWNĄTRZ FILTRA */
        .facet-mini-search { 
            width: 100%; padding: 5px; font-size: 12px; border: 1px solid #ccc; 
            box-sizing: border-box; outline: none; margin-bottom: 5px;
        }

        .facet-list { list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; background: #fff; }
        .facet-item { font-size: 12px; padding: 6px 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; }
        .facet-item.active { background: #1a1a1a !important; color: #fff !important; }
        .count-pill { font-size: 9px; background: #eee; padding: 2px 5px; border-radius: 10px; color: #333; }

        #main-content { flex: 1 1 auto; display: flex; flex-direction: column; overflow: hidden; }
        .controls { flex: 0 0 auto; background: #fff; padding: 15px 10px; border-bottom: 2px solid #1a1a1a; display: flex; flex-direction: column; gap: 10px; }
        #search { width: 100%; padding: 10px 15px; border: 1px solid #1a1a1a; font-size: 17px; box-sizing: border-box; outline: none; }
        #container { flex: 1 1 auto; overflow-y: scroll; padding: 15px 10px; box-sizing: border-box; background: #fff; }
        
        .item-card { border: 1px solid #eee; margin-bottom: 15px; padding: 18px; cursor: pointer; }
        .row-flex { display: flex; justify-content: space-between; gap: 15px; }
        .title-pl { font-weight: bold; font-size: 17px; text-transform: uppercase; }
        .title-heb { font-size: 19px; direction: rtl; font-family: "SBL Hebrew", serif; }
        
        .clear-btn { font-size: 9px; cursor: pointer; text-decoration: underline; color: #666; font-weight: bold; }
    </style>
</head><body>

    <header id="main-header">
        <div class="header-title" dir="rtl">בית עקד ספרים בישיבת חכמי לובלין</div>
        <div class="header-links">
            <a href="#">O projekcie</a>
            <a href="#">About</a>
        </div>
    </header>

    <div id="app-container">
        <aside id="sidebar">
            <div style="padding-bottom: 10px;">
                <span class="clear-btn" onclick="clearFacet('all')">Wyczyść wszystko / Reset all</span>
            </div>

            <details class="facet-container" open>
                <summary class="facet-summary">
                    Autor / Author
                    <span id="authorActiveCount" style="font-size:9px; background:#1a1a1a; color:#fff; padding:0 4px; border-radius:3px; display:none;">0</span>
                </summary>
                <div class="facet-inner-content">
                    <input type="text" class="facet-mini-search" placeholder="Filtruj listę..." onkeyup="filterFacetList(this, 'authorListPL')">
                    <ul id="authorListPL" class="facet-list"></ul>
                </div>
            </details>

            <div class="facet-section">
                <div class="facet-header"><span class="facet-title">Miasto / City</span></div>
                <ul id="cityListPL" class="facet-list"></ul>
            </div>
        </aside>

        <main id="main-content">
            <div class="controls">
                <input type="text" id="search" placeholder="SZUKAJ / SEARCH / חפש..." onkeyup="filterAndSort()">
            </div>
            <div id="container"></div>
        </main>
    </div>

    <script>
        let rawRows = [];
        let activeFilters = { city: new Set(), author: new Set() };
        let sheetId = '1N--MCZSwjbLchUT37i-Ph5TwHoMxqNXUsO_zPngtokg';
        let url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

        // Funkcja do filtrowania samej listy nazwisk wewnątrz akordeonu
        function filterFacetList(input, listId) {
            let filter = input.value.toLowerCase();
            let items = document.querySelectorAll(`#${listId} li`);
            items.forEach(li => {
                let txt = li.innerText.toLowerCase();
                li.style.display = txt.includes(filter) ? "flex" : "none";
            });
        }

        async function init() {
            try {
                let r = await fetch(url);
                let t = await r.text();
                let json = JSON.parse(t.substring(t.indexOf("{"), t.lastIndexOf("}") + 1));
                rawRows = json.table.rows;
                filterAndSort();
            } catch (e) { console.error(e); }
        }

        function getVal(cell) { return cell && (cell.f || (cell.v !== null ? String(cell.v) : "")) || ""; }

        function clearFacet(type) {
            if (type === 'all') { activeFilters.city.clear(); activeFilters.author.clear(); }
            else activeFilters[type].clear();
            filterAndSort();
        }

        function toggleFilter(val, type) {
            if (activeFilters[type].has(val)) activeFilters[type].delete(val);
            else activeFilters[type].add(val);
            filterAndSort();
        }

        function filterAndSort() {
            const term = document.getElementById('search').value.toLowerCase().trim();
            const filtered = rawRows.filter(r => {
                const city = getVal(r.c[7]), auth = getVal(r.c[3]);
                const matchSearch = r.c.some(c => getVal(c).toLowerCase().includes(term));
                const matchCity = activeFilters.city.size === 0 || activeFilters.city.has(city.trim());
                const matchAuth = activeFilters.author.size === 0 || activeFilters.author.has(auth.trim());
                return matchSearch && matchCity && matchAuth;
            });
            updateFacetsUI(term);
            render(filtered);

            // Aktualizacja licznika na nagłówku akordeonu
            let authCounter = document.getElementById('authorActiveCount');
            authCounter.innerText = activeFilters.author.size;
            authCounter.style.display = activeFilters.author.size > 0 ? 'inline' : 'none';
        }

        function updateFacetsUI(term) {
            const counts = { city: {}, author: {} };
            rawRows.forEach(r => {
                if (!r.c.some(c => getVal(c).toLowerCase().includes(term))) return;
                const city = getVal(r.c[7]).trim(), auth = getVal(r.c[3]).trim();
                if (activeFilters.author.size === 0 || activeFilters.author.has(auth)) counts.city[city] = (counts.city[city] || 0) + 1;
                if (activeFilters.city.size === 0 || activeFilters.city.has(city)) counts.author[auth] = (counts.author[auth] || 0) + 1;
            });
            renderFacetList('authorListPL', counts.author, 'author');
            renderFacetList('cityListPL', counts.city, 'city');
        }

        function renderFacetList(id, counts, type) {
            const list = document.getElementById(id);
            const sortedKeys = Object.keys(counts).sort((a,b) => a.localeCompare(b));
            list.innerHTML = sortedKeys.map(k => {
                const active = activeFilters[type].has(k) ? 'active' : '';
                return `<li class="facet-item ${active}" onclick="toggleFilter('${k}', '${type}')">
                    <span>${k}</span><span class="count-pill">${counts[k]}</span>
                </li>`;
            }).join('');
        }

        function render(rows) {
            document.getElementById('container').innerHTML = rows.map(r => `
                <div class="item-card">
                    <div class="row-flex">
                        <span class="title-pl">${getVal(r.c[1])}</span>
                        <span class="title-heb">${getVal(r.c[2])}</span>
                    </div>
                </div>
            `).join('');
        }

        init();
    </script>
</body></html>
